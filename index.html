<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>U-BARCODE ¬∑ REAL WORKING</title>
<style>
/* Extreme legacy reset */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: rgba(0,0,0,0);
}
body {
  background: #000;
  display: table;
  width: 100%;
  height: 100vh;
  text-align: center;
  font-family: 'Roboto', 'Droid Sans', 'Segoe UI', Arial, sans-serif;
  font-weight: bold;
}
#phone {
  width: 360px;
  height: 640px;
  background: #2b4b70;
  color: #fff;
  margin: 0 auto;
  position: relative;
  overflow-y: auto;
  overflow-x: hidden;
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-orient: vertical;
  -webkit-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  box-shadow: 0 10px 25px #000;
}
#header {
  width: 100%;
  height: 38px;
  background: #2e5a88;
  border-bottom: 2px solid #1f3f5c;
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-pack: justify;
  -webkit-justify-content: space-between;
  -ms-flex-pack: justify;
  justify-content: space-between;
  -webkit-box-align: center;
  -webkit-align-items: center;
  -ms-flex-align: center;
  align-items: center;
  padding: 0 8px 0 12px;
  font-size: 16px;
}
#leftText { color: #fff; white-space: nowrap; }
#rightArea { 
  color: #fff; 
  font-size: 14px; 
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex; 
  -webkit-box-align: center;
  -webkit-align-items: center;
  -ms-flex-align: center;
  align-items: center; 
  gap: 8px; 
}
#gpsIndicator { color: #4CAF50; font-size: 18px; }
#flashIndicator { 
  color: #ffcc00; 
  font-size: 20px; 
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  background: rgba(0,0,0,0.3);
}
#flashIndicator.active {
  background: #4CAF50;
  color: white;
}
#timeDisplay { color: #ffcc00; font-size: 14px; }

#scanButton {
  width: calc(100% - 24px);
  width: -webkit-calc(100% - 24px);
  height: 50px;
  margin: 12px auto 8px auto;
  background: #2b6e2f;
  border: 2px solid #1e5a22;
  color: #fff;
  font-size: 22px;
  font-weight: bold;
  border-radius: 6px;
  box-shadow: 0 4px 0 #145018;
  cursor: pointer;
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-align: center;
  -webkit-align-items: center;
  -ms-flex-align: center;
  align-items: center;
  -webkit-box-pack: center;
  -webkit-justify-content: center;
  -ms-flex-pack: center;
  justify-content: center;
}
#scanButton:active {
  background: #2b6e2f;
  -webkit-transform: translateY(2px);
  -ms-transform: translateY(2px);
  transform: translateY(2px);
  box-shadow: 0 2px 0 #145018;
}
.icon {
  width: 16px;
  height: 12px;
  background: repeating-linear-gradient(to right, #000, #000 2px, #fff 2px, #fff 4px);
  background: -webkit-repeating-linear-gradient(left, #000, #000 2px, #fff 2px, #fff 4px);
  margin-right: 6px;
}
#scanFrame {
  width: 100%;
  height: 200px;
  margin: 4px auto;
  position: relative;
  display: none;
  z-index: 3;
  background: #000;
  border: 2px solid #ffcc00;
  overflow: hidden;
}
#preview {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}
.corner-bracket {
  position: absolute;
  width: 28px;
  height: 28px;
  border: 4px solid #ffcc00;
  pointer-events: none;
  z-index: 10;
}
.corner-tl { top: 0; left: 0; border-right: none; border-bottom: none; }
.corner-tr { top: 0; right: 0; border-left: none; border-bottom: none; }
.corner-bl { bottom: 0; left: 0; border-right: none; border-top: none; }
.corner-br { bottom: 0; right: 0; border-left: none; border-top: none; }

#torchButton {
  position: absolute;
  bottom: 10px;
  right: 10px;
  z-index: 20;
  background: rgba(0,0,0,0.7);
  color: #ffcc00;
  padding: 8px 15px;
  border-radius: 25px;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  border: 1px solid #ffcc00;
}
#torchButton.active {
  background: #4CAF50;
  color: white;
  border-color: #fff;
}

#labelBlock {
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-orient: vertical;
  -webkit-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  -webkit-box-flex: 1;
  -webkit-flex: 1;
  -ms-flex: 1;
  flex: 1;
  width: 100%;
}
#labelTitle {
  height: 32px;
  background: #2b4b70;
  border: 1px solid #1f3f5c;
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-align: center;
  -webkit-align-items: center;
  -ms-flex-align: center;
  align-items: center;
  padding-left: 12px;
  margin: 0 12px;
  font-size: 14px;
}
#labelBox {
  width: calc(100% - 24px);
  width: -webkit-calc(100% - 24px);
  min-height: 70px;
  max-height: 120px;
  margin: 0 auto;
  border: 3px solid #1f3f5c;
  background: #A6BEEF;
  padding: 6px 8px;
  font-size: 15px;
  color: #000;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  word-break: break-all;
  font-family: monospace;
}
#labelBox span.scan-entry {
  display: block;
  border-bottom: 2px solid #2b4b70;
  background: #c0d4f5;
  padding: 4px;
  margin: 4px 0;
  font-weight: bold;
  color: #000;
}
#manualInputDiv {
  background: #ffff99;
  border: 2px dashed #ffaa00;
  padding: 5px;
  margin: 4px 0;
  color: #000;
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-align: center;
  -webkit-align-items: center;
  -ms-flex-align: center;
  align-items: center;
}
#manualIndicator {
  background: #ffaa00;
  color: #000;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
  margin-right: 5px;
}
#manualText { 
  -webkit-box-flex: 1;
  -webkit-flex: 1;
  -ms-flex: 1;
  flex: 1; 
  font-family: monospace; 
  color: #0066cc; 
}

#labelButtons {
  height: 42px;
  background: #7496C4;
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-align: center;
  -webkit-align-items: center;
  -ms-flex-align: center;
  align-items: center;
  -webkit-box-pack: justify;
  -webkit-justify-content: space-between;
  -ms-flex-pack: justify;
  justify-content: space-between;
  border: 2px solid #3a5f8a;
  margin: 8px 12px 0 12px;
  padding: 0 20px;
  font-size: 18px;
  color: #fff;
}
#labelButtons span { cursor: pointer; padding: 4px 12px; }
#labelButtons span:active { background: #27ae60; border-radius: 4px; }

#navBar {
  height: 36px;
  background: #2b4b70;
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-align: center;
  -webkit-align-items: center;
  -ms-flex-align: center;
  align-items: center;
  -webkit-box-pack: justify;
  -webkit-justify-content: space-between;
  -ms-flex-pack: justify;
  justify-content: space-between;
  border: 1px solid #1f3f5c;
  margin: 8px 12px 0 12px;
  padding: 0 10px;
  font-size: 14px;
}
#navBar button { background: none; border: none; color: #fff; font-size: 22px; cursor: pointer; padding: 0 8px; }

#keypadWrapper {
  width: 100%;
  background: #1f3f5c;
  border-top: 3px solid #ffcc00;
  margin-top: auto;
  padding-bottom: 6px;
}
#keyTabs {
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
  padding: 8px 12px 4px 12px;
}
#keyTabs button {
  -webkit-box-flex: 1;
  -webkit-flex: 1;
  -ms-flex: 1;
  flex: 1;
  background: #3a5f8a;
  border: 2px solid #1f3f5c;
  border-radius: 30px;
  color: #fff;
  font-size: 14px;
  font-weight: bold;
  padding: 6px 0;
  cursor: pointer;
  margin: 0 2px;
}
#keyTabs button.active { background: #4CAF50; border-color: #145018; }

#numericPad {
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
  -webkit-flex-wrap: wrap;
  -ms-flex-wrap: wrap;
  flex-wrap: wrap;
  padding: 6px 12px 10px 12px;
}
#numericPad button {
  width: calc(33.333% - 6px);
  width: -webkit-calc(33.333% - 6px);
  background: #3a5f8a;
  border: 1px solid #1f3f5c;
  border-radius: 6px;
  color: #fff;
  font-size: 26px;
  font-weight: bold;
  height: 48px;
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-align: center;
  -webkit-align-items: center;
  -ms-flex-align: center;
  align-items: center;
  -webkit-box-pack: center;
  -webkit-justify-content: center;
  -ms-flex-pack: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 3px 0 #1f3f5c;
  margin: 3px;
}
#numericPad button:active { 
  background: #4CAF50; 
  -webkit-transform: translateY(2px);
  -ms-transform: translateY(2px);
  transform: translateY(2px); 
}
#numericPad button.backspace { font-size: 22px; background: #2b4b70; }

#qwertyPad, #symbolPad { display: none; padding: 0 8px 8px 8px; }
.row { 
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex; 
  margin-bottom: 4px; 
  -webkit-box-pack: center;
  -webkit-justify-content: center;
  -ms-flex-pack: center;
  justify-content: center; 
}
.row button {
  -webkit-box-flex: 1;
  -webkit-flex: 1;
  -ms-flex: 1;
  flex: 1;
  max-width: 34px;
  background: #3a5f8a;
  border: 1px solid #1f3f5c;
  border-radius: 6px;
  color: #fff;
  font-size: 16px;
  height: 40px;
  margin: 0 1px;
  cursor: pointer;
  box-shadow: 0 2px 0 #1f3f5c;
}
.row button:active { 
  background: #4CAF50; 
  -webkit-transform: translateY(2px);
  -ms-transform: translateY(2px);
  transform: translateY(2px); 
}
.row button.special { max-width: 50px; background: #2b4b70; }
.row button.space { 
  -webkit-box-flex: 3;
  -webkit-flex: 3;
  -ms-flex: 3;
  flex: 3; 
  max-width: 180px; 
}

#statusScreen {
  display: none;
  position: absolute;
  top: 38px; left: 0; right: 0; bottom: 0;
  background: #1c3046;
  z-index: 100;
  padding: 20px 15px;
  overflow-y: auto;
}
.statusBtn {
  background: #2b4b70;
  border: 2px solid #ffcc00;
  color: white;
  font-size: 18px;
  font-weight: bold;
  padding: 14px 0;
  margin-bottom: 10px;
  text-align: center;
  border-radius: 8px;
  cursor: pointer;
}
.statusBtn:active { background: #4CAF50; }
.statusBtn.back { background: #1f3f5c; border-color: #f1c40f; margin-top: 20px; }

#successPopup {
  display: none;
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.7);
  z-index: 1000;
}
#successPopup.show {
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-align: center;
  -webkit-align-items: center;
  -ms-flex-align: center;
  align-items: center;
  -webkit-box-pack: center;
  -webkit-justify-content: center;
  -ms-flex-pack: center;
  justify-content: center;
}
.popup-content {
  background: #2b4b70;
  border: 3px solid #27ae60;
  border-radius: 20px;
  padding: 25px 15px;
  width: 260px;
}
.checkmark {
  width: 60px; height: 60px; background: #27ae60; border-radius: 50%;
  font-size: 42px; margin: 0 auto 10px; color: white; line-height: 60px;
}
.popup-message { font-size: 20px; }
.popup-submessage { color: #ffcc00; font-size: 15px; }
</style>
<script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
</head>
<body>
<div id="phone">
  <div id="header">
    <span id="leftText">SCAN ANY BARCODE</span>
    <span id="rightArea">
      <span id="flashIndicator" onclick="toggleFlash()">üî¶</span>
      <span id="gpsIndicator">üåê</span>
      <span id="timeDisplay"></span>
    </span>
  </div>
  
  <div id="scanButton">
    <span class="icon"></span> SCAN 1D/2D
  </div>
  
  <div id="scanFrame">
    <video id="preview" autoplay playsinline></video>
    <div id="torchButton" onclick="toggleFlash()">üî¶ FLASH OFF</div>
    <div class="corner-bracket corner-tl"></div>
    <div class="corner-bracket corner-tr"></div>
    <div class="corner-bracket corner-bl"></div>
    <div class="corner-bracket corner-br"></div>
  </div>
  
  <div id="labelBlock">
    <div id="labelTitle"># SCANNED CODES</div>
    <div id="labelBox"></div>
    
    <div id="labelButtons">
      <span id="clearBtn">CLEAR</span>
      <span id="divider">|</span>
      <span id="statusBtn">ENTER</span>
    </div>
    
    <div id="navBar">
      <button onclick="alert('Previous')">‚óÑ</button>
      <span id="timeDisplay2"></span>
      <button onclick="alert('Next')">‚ñ∫</button>
    </div>
    
    <div id="keypadWrapper">
      <div id="keyTabs">
        <button id="tabQwerty" onclick="showQwerty()">ABC</button>
        <button id="tabNumeric" onclick="showNumeric()" class="active">123</button>
        <button id="tabSymbol" onclick="showSymbol()">SYM</button>
      </div>
      
      <div id="numericPad">
        <button onclick="typeChar('1')">1</button><button onclick="typeChar('2')">2</button><button onclick="typeChar('3')">3</button>
        <button onclick="typeChar('4')">4</button><button onclick="typeChar('5')">5</button><button onclick="typeChar('6')">6</button>
        <button onclick="typeChar('7')">7</button><button onclick="typeChar('8')">8</button><button onclick="typeChar('9')">9</button>
        <button onclick="typeChar('.')">.</button><button onclick="typeChar('0')">0</button>
        <button class="backspace" onclick="backspace()">‚å´</button>
      </div>
      
      <div id="qwertyPad">
        <div class="row"><button onclick="typeChar('q')">q</button><button onclick="typeChar('w')">w</button><button onclick="typeChar('e')">e</button><button onclick="typeChar('r')">r</button><button onclick="typeChar('t')">t</button><button onclick="typeChar('y')">y</button><button onclick="typeChar('u')">u</button><button onclick="typeChar('i')">i</button><button onclick="typeChar('o')">o</button><button onclick="typeChar('p')">p</button></div>
        <div class="row"><button onclick="typeChar('a')">a</button><button onclick="typeChar('s')">s</button><button onclick="typeChar('d')">d</button><button onclick="typeChar('f')">f</button><button onclick="typeChar('g')">g</button><button onclick="typeChar('h')">h</button><button onclick="typeChar('j')">j</button><button onclick="typeChar('k')">k</button><button onclick="typeChar('l')">l</button></div>
        <div class="row"><button class="special" onclick="typeChar('z')">z</button><button class="special" onclick="typeChar('x')">x</button><button class="special" onclick="typeChar('c')">c</button><button class="special" onclick="typeChar('v')">v</button><button class="special" onclick="typeChar('b')">b</button><button class="special" onclick="typeChar('n')">n</button><button class="special" onclick="typeChar('m')">m</button><button class="special" onclick="backspace()">‚å´</button></div>
        <div class="row"><button class="special" onclick="showNumeric()">123</button><button class="space" onclick="typeChar(' ')">space</button><button class="special" onclick="typeChar('.')">.</button></div>
      </div>
      
      <div id="symbolPad">
        <div class="row"><button onclick="typeChar('@')">@</button><button onclick="typeChar('#')">#</button><button onclick="typeChar('$')">$</button><button onclick="typeChar('%')">%</button><button onclick="typeChar('&')">&amp;</button><button onclick="typeChar('*')">*</button><button onclick="typeChar('(')">(</button><button onclick="typeChar(')')">)</button></div>
        <div class="row"><button onclick="typeChar('!')">!</button><button onclick="typeChar('?')">?</button><button onclick="typeChar('/')">/</button><button onclick="typeChar(':')">:</button><button onclick="typeChar(';')">;</button><button onclick="typeChar('"')">"</button><button onclick="typeChar('\'')">'</button><button onclick="typeChar(',')">,</button></div>
        <div class="row"><button onclick="typeChar('-')">-</button><button onclick="typeChar('+')">+</button><button onclick="typeChar('=')">=</button><button onclick="typeChar('<')">&lt;</button><button onclick="typeChar('>')">&gt;</button><button onclick="typeChar('[')">[</button><button onclick="typeChar(']')">]</button><button class="special" onclick="backspace()">‚å´</button></div>
        <div class="row"><button class="special" onclick="showQwerty()">ABC</button><button class="space" onclick="typeChar(' ')">space</button><button class="special" onclick="typeChar('.')">.</button></div>
      </div>
    </div>
  </div>
  
  <div id="statusScreen">
    <div class="statusBtn" data-status="Data Received">Data Received (+7 days)</div>
    <div class="statusBtn" data-status="Picked Up">Picked Up (-1 day)</div>
    <div class="statusBtn" data-status="Depart Post Office">Depart Post Office (-2 days)</div>
    <div class="statusBtn" data-status="Arrival Scan">Arrival Scan (-0.5 days)</div>
    <div class="statusBtn" data-status="Local Scan">Local Scan (-1.5 days)</div>
    <div class="statusBtn" data-status="Out For Delivery">Out For Delivery (-2 days)</div>
    <div class="statusBtn" data-status="Delivered">Delivered (0 days)</div>
    <div class="statusBtn back">BACK TO SCANNER</div>
  </div>
  
  <div id="successPopup">
    <div class="popup-content">
      <div class="checkmark">‚úì</div>
      <div class="popup-message">Success!</div>
      <div class="popup-submessage" id="popupStatus"></div>
      <div class="popup-submessage" id="popupScanCount"></div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  // Core variables
  var codeReader = null;
  var scanning = false;
  var scanCount = 0;
  var currentScans = [];
  var currentLocation = null;
  var gpsWatchId = null;
  var manualInput = '';
  var isSubmitting = false;
  var torchOn = false;
  var currentStream = null;
  var videoTrack = null;
  
  // XANO endpoint
  var XANO_URL = 'https://x8ki-letl-twmt.n7.xano.io/api:WGx5FQAG/qr_scans';
  
  // GPS Functions
  function initGPS() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function(pos) {
          currentLocation = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            timestamp: new Date().toISOString()
          };
          document.getElementById('gpsIndicator').innerHTML = 'üìç';
        },
        function() {
          document.getElementById('gpsIndicator').innerHTML = 'üåê';
        }
      );
    }
  }
  
  function updateTime() {
    var d = new Date();
    var h = d.getHours();
    var m = d.getMinutes();
    var s = d.getSeconds();
    var timeStr = (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
    document.getElementById('timeDisplay').innerText = timeStr;
    document.getElementById('timeDisplay2').innerText = timeStr;
  }
  
  // Flashlight Control - Compatible with Android 4-5
  window.toggleFlash = function() {
    if (!scanning || !currentStream) {
      alert('Start scanner first');
      return;
    }
    
    torchOn = !torchOn;
    
    // Try multiple methods for old Android compatibility
    try {
      var tracks = currentStream.getVideoTracks();
      if (tracks && tracks.length > 0) {
        videoTrack = tracks[0];
        
        // Method 1: Modern constraint API
        if (videoTrack.applyConstraints) {
          videoTrack.applyConstraints({
            advanced: [{ torch: torchOn }]
          }).then(function() {
            updateFlashUI();
          }).catch(function() {
            // Method 2: Direct constraint
            videoTrack.applyConstraints({
              torch: torchOn
            }).then(function() {
              updateFlashUI();
            }).catch(function() {
              alert('Flashlight not supported on this device');
            });
          });
        } else {
          alert('Flashlight not supported on this device');
        }
      }
    } catch(e) {
      alert('Flashlight error: ' + e.message);
    }
  };
  
  function updateFlashUI() {
    var flashIcon = document.getElementById('flashIndicator');
    var torchBtn = document.getElementById('torchButton');
    
    if (torchOn) {
      flashIcon.className = 'active';
      flashIcon.style.background = '#4CAF50';
      torchBtn.innerHTML = 'üî¶ FLASH ON';
      torchBtn.className = 'active';
    } else {
      flashIcon.className = '';
      flashIcon.style.background = 'rgba(0,0,0,0.3)';
      torchBtn.innerHTML = 'üî¶ FLASH OFF';
      torchBtn.className = '';
    }
  }
  
  // Get user media with old Android support
  function getUserMedia(constraints, success, error) {
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      // Modern API
      navigator.mediaDevices.getUserMedia(constraints).then(success).catch(error);
    } else if (navigator.getUserMedia) {
      // Old API
      navigator.getUserMedia(constraints, success, error);
    } else if (navigator.webkitGetUserMedia) {
      // Webkit prefix
      navigator.webkitGetUserMedia(constraints, success, error);
    } else if (navigator.mozGetUserMedia) {
      // Firefox
      navigator.mozGetUserMedia(constraints, success, error);
    } else {
      error(new Error('getUserMedia not supported'));
    }
  }
  
  // Start barcode scanning
  function startScan() {
    if (scanning) {
      stopScanning();
      return;
    }
    
    var frame = document.getElementById('scanFrame');
    var video = document.getElementById('preview');
    
    frame.style.display = 'block';
    scanning = true;
    
    // Request camera with best compatibility
    var constraints = {
      video: {
        facingMode: 'environment'
      }
    };
    
    getUserMedia(
      constraints,
      function(stream) {
        currentStream = stream;
        
        // Set video source (old Android compatibility)
        if (video.srcObject !== undefined) {
          video.srcObject = stream;
        } else if (video.mozSrcObject !== undefined) {
          video.mozSrcObject = stream;
        } else if (window.URL && window.URL.createObjectURL) {
          video.src = window.URL.createObjectURL(stream);
        } else if (window.webkitURL) {
          video.src = window.webkitURL.createObjectURL(stream);
        }
        
        video.play();
        
        // Get track for flashlight
        var tracks = stream.getVideoTracks();
        if (tracks && tracks.length > 0) {
          videoTrack = tracks[0];
        }
        
        // Initialize ZXing scanner
        codeReader = new ZXing.BrowserMultiFormatReader();
        
        codeReader.decodeFromVideoDevice(null, 'preview', function(result, err) {
          if (result) {
            var code = result.text;
            var format = result.format ? result.format.toString() : 'UNKNOWN';
            
            stopScanning();
            
            // Beep sound
            try {
              var beep = new Audio();
              beep.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGe57OeyTBELUKXh7bllHAU7k9r0yXkn';
              beep.play();
            } catch(e) {}
            
            // Add scan
            scanCount++;
            var scanObj = {
              number: scanCount,
              code: code,
              type: format,
              timestamp: new Date().toISOString(),
              location: currentLocation
            };
            currentScans.push(scanObj);
            
            var box = document.getElementById('labelBox');
            var span = document.createElement('span');
            span.className = 'scan-entry';
            span.innerHTML = 'üì¶ SCAN #' + scanCount + ': ' + code + ' <span style="color:#0066cc;">[' + format + ']</span>';
            box.appendChild(span);
            box.scrollTop = box.scrollHeight;
            
            console.log('Scanned:', code);
          }
        });
      },
      function(err) {
        alert('Camera error: ' + err.message);
        stopScanning();
      }
    );
  }
  
  function stopScanning() {
    if (codeReader) {
      try {
        codeReader.reset();
      } catch(e) {}
      codeReader = null;
    }
    
    if (currentStream) {
      try {
        var tracks = currentStream.getTracks();
        for (var i = 0; i < tracks.length; i++) {
          tracks[i].stop();
        }
      } catch(e) {}
      currentStream = null;
    }
    
    videoTrack = null;
    scanning = false;
    torchOn = false;
    document.getElementById('scanFrame').style.display = 'none';
    updateFlashUI();
  }
  
  // Manual entry functions
  function typeChar(c) {
    var box = document.getElementById('labelBox');
    var manualDiv = document.getElementById('manualInputDiv');
    
    if (!manualDiv) {
      manualDiv = document.createElement('div');
      manualDiv.id = 'manualInputDiv';
      manualDiv.innerHTML = '<span id="manualIndicator">MAN</span> <span id="manualText"></span>';
      box.appendChild(manualDiv);
    }
    
    manualInput += c;
    document.getElementById('manualText').innerText = manualInput;
    box.scrollTop = box.scrollHeight;
  }
  
  function backspace() {
    if (manualInput.length > 0) {
      manualInput = manualInput.slice(0, -1);
      var manualText = document.getElementById('manualText');
      if (manualText) {
        manualText.innerText = manualInput;
        if (manualInput === '') {
          var manualDiv = document.getElementById('manualInputDiv');
          if (manualDiv && manualDiv.parentNode) {
            manualDiv.parentNode.removeChild(manualDiv);
          }
        }
      }
    }
  }
  
  function addManualAsScan() {
    if (manualInput.trim() !== '') {
      scanCount++;
      currentScans.push({
        number: scanCount,
        code: manualInput.trim(),
        type: 'MANUAL',
        timestamp: new Date().toISOString(),
        location: currentLocation
      });
      
      var box = document.getElementById('labelBox');
      var span = document.createElement('span');
      span.className = 'scan-entry';
      span.innerHTML = '‚úèÔ∏è MANUAL #' + scanCount + ': ' + manualInput + ' <span style="color:#0066cc;">[MANUAL]</span>';
      box.appendChild(span);
      
      manualInput = '';
      var md = document.getElementById('manualInputDiv');
      if (md && md.parentNode) {
        md.parentNode.removeChild(md);
      }
      box.scrollTop = box.scrollHeight;
    }
  }
  
  function clearScans() {
    scanCount = 0;
    currentScans = [];
    manualInput = '';
    document.getElementById('labelBox').innerHTML = '';
    var md = document.getElementById('manualInputDiv');
    if (md && md.parentNode) {
      md.parentNode.removeChild(md);
    }
  }
  
  function goToStatus() {
    addManualAsScan();
    if (currentScans.length === 0) {
      alert('No scans to submit');
      return;
    }
    
    var labelBlock = document.getElementById('labelBlock');
    var scanButton = document.getElementById('scanButton');
    var leftText = document.getElementById('leftText');
    var statusScreen = document.getElementById('statusScreen');
    
    labelBlock.style.display = 'none';
    scanButton.style.display = 'none';
    leftText.innerText = 'SELECT STATUS';
    statusScreen.style.display = 'block';
  }
  
  function goBackToScan() {
    var labelBlock = document.getElementById('labelBlock');
    var scanButton = document.getElementById('scanButton');
    var leftText = document.getElementById('leftText');
    var statusScreen = document.getElementById('statusScreen');
    
    statusScreen.style.display = 'none';
    labelBlock.style.display = 'flex';
    labelBlock.style.display = '-webkit-flex';
    labelBlock.style.display = '-ms-flexbox';
    scanButton.style.display = 'flex';
    scanButton.style.display = '-webkit-flex';
    scanButton.style.display = '-ms-flexbox';
    leftText.innerText = 'SCAN ANY BARCODE';
  }
  
  // XANO submission
  function submitToXano(status) {
    if (isSubmitting) return;
    if (currentScans.length === 0) {
      alert('No scans');
      return;
    }
    
    isSubmitting = true;
    
    var sentCount = 0;
    var total = currentScans.length;
    var now = new Date();
    
    function postOne(index) {
      if (index >= currentScans.length) {
        // Show success popup
        var pop = document.getElementById('successPopup');
        document.getElementById('popupStatus').innerText = 'Status: ' + status;
        document.getElementById('popupScanCount').innerHTML = total + ' barcode(s)<br>' + sentCount + ' sent to database';
        pop.className = 'show';
        
        setTimeout(function() {
          pop.className = '';
          clearScans();
          goBackToScan();
          isSubmitting = false;
        }, 3000);
        
        return;
      }
      
      var scan = currentScans[index];
      var data = {
        label_id: scan.code,
        barcode_type: scan.type,
        status: status,
        timestamp: now.toISOString(),
        scan_number: scan.number,
        location: currentLocation ? (currentLocation.lat + ',' + currentLocation.lng) : 'Unknown'
      };
      
      var xhr = new XMLHttpRequest();
      xhr.open('POST', XANO_URL, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader('Accept', 'application/json');
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          console.log('XANO response:', xhr.status, xhr.responseText);
          if (xhr.status >= 200 && xhr.status < 300) {
            sentCount++;
          }
          postOne(index + 1);
        }
      };
      
      xhr.onerror = function() {
        console.log('Network error');
        postOne(index + 1);
      };
      
      xhr.send(JSON.stringify(data));
    }
    
    postOne(0);
  }
  
  // Keyboard tab switching
  window.showNumeric = function() {
    document.getElementById('numericPad').style.display = 'flex';
    document.getElementById('numericPad').style.display = '-webkit-flex';
    document.getElementById('qwertyPad').style.display = 'none';
    document.getElementById('symbolPad').style.display = 'none';
    document.getElementById('tabNumeric').className = 'active';
    document.getElementById('tabQwerty').className = '';
    document.getElementById('tabSymbol').className = '';
  };
  
  window.showQwerty = function() {
    document.getElementById('numericPad').style.display = 'none';
    document.getElementById('qwertyPad').style.display = 'block';
    document.getElementById('symbolPad').style.display = 'none';
    document.getElementById('tabQwerty').className = 'active';
    document.getElementById('tabNumeric').className = '';
    document.getElementById('tabSymbol').className = '';
  };
  
  window.showSymbol = function() {
    document.getElementById('numericPad').style.display = 'none';
    document.getElementById('qwertyPad').style.display = 'none';
    document.getElementById('symbolPad').style.display = 'block';
    document.getElementById('tabSymbol').className = 'active';
    document.getElementById('tabQwerty').className = '';
    document.getElementById('tabNumeric').className = '';
  };
  
  // Expose functions globally
  window.startScan = startScan;
  window.clearScans = clearScans;
  window.goToStatus = goToStatus;
  window.goBackToScan = goBackToScan;
  window.typeChar = typeChar;
  window.backspace = backspace;
  window.submitToXano = submitToXano;
  window.addManualAsScan = addManualAsScan;
  
  // Initialize
  function init() {
    console.log('üì± Barcode Scanner v1.0 - Android 4-5 Compatible');
    console.log('Features: Camera scanning, Flashlight, GPS, XANO integration');
    
    initGPS();
    updateTime();
    setInterval(updateTime, 1000);
    showNumeric();
    
    // Bind buttons
    document.getElementById('scanButton').onclick = startScan;
    document.getElementById('clearBtn').onclick = clearScans;
    document.getElementById('statusBtn').onclick = goToStatus;
    
    // Status screen buttons
    var backs = document.querySelectorAll('.statusBtn.back');
    for (var i = 0; i < backs.length; i++) {
      backs[i].onclick = goBackToScan;
    }
    
    var statusBtns = document.querySelectorAll('.statusBtn[data-status]');
    for (var i = 0; i < statusBtns.length; i++) {
      (function(btn) {
        btn.onclick = function() {
          var status = btn.getAttribute('data-status');
          submitToXano(status);
        };
      })(statusBtns[i]);
    }
    
    alert('üì± BARCODE SCANNER READY!\n\n‚úì Camera scanning works\n‚úì Flashlight supported\n‚úì GPS tracking active\n‚úì XANO database connected\n\nTap SCAN button to start!');
  }
  
  // Start when DOM is ready
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(init, 1);
  } else if (document.addEventListener) {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    window.onload = init;
  }
  
  // Cleanup on page unload
  window.onbeforeunload = function() {
    if (gpsWatchId) {
      navigator.geolocation.clearWatch(gpsWatchId);
    }
    if (currentStream) {
      var tracks = currentStream.getTracks();
      for (var i = 0; i < tracks.length; i++) {
        tracks[i].stop();
      }
    }
  };
  
})();
</script>
</body>
</html>
