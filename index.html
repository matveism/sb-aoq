<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>U-BARCODE ¬∑ DIRECT CAMERA</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: rgba(0,0,0,0);
}
body {
  background: #000;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  font-family: Arial, sans-serif;
}
#phone {
  width: 360px;
  height: 640px;
  background: #2b4b70;
  color: #fff;
  position: relative;
  display: flex;
  flex-direction: column;
  box-shadow: 0 10px 25px #000;
}
#header {
  height: 38px;
  background: #2e5a88;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 12px;
  font-size: 16px;
}
#gpsIndicator { color: #4CAF50; font-size: 18px; }
#timeDisplay { color: #ffcc00; }

#scanButton {
  height: 50px;
  background: #2b6e2f;
  border: 2px solid #1e5a22;
  border-radius: 6px;
  margin: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 4px 0 #145018;
}
#scanButton:active {
  transform: translateY(2px);
  box-shadow: 0 2px 0 #145018;
}

#scanFrame {
  width: 100%;
  height: 200px;
  margin: 4px 0;
  position: relative;
  display: none;
  background: #000;
  border: 2px solid #ffcc00;
  overflow: hidden;
}
#preview {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

#torchButton {
  position: absolute;
  bottom: 10px;
  right: 10px;
  background: rgba(0,0,0,0.7);
  color: #ffcc00;
  padding: 8px 15px;
  border-radius: 25px;
  font-size: 14px;
  cursor: pointer;
  border: 1px solid #ffcc00;
  z-index: 20;
}
#torchButton.active {
  background: #4CAF50;
  color: white;
}

.corner-bracket {
  position: absolute;
  width: 28px;
  height: 28px;
  border: 4px solid #ffcc00;
  pointer-events: none;
  z-index: 10;
}
.corner-tl { top: 0; left: 0; border-right: none; border-bottom: none; }
.corner-tr { top: 0; right: 0; border-left: none; border-bottom: none; }
.corner-bl { bottom: 0; left: 0; border-right: none; border-top: none; }
.corner-br { bottom: 0; right: 0; border-left: none; border-top: none; }

#labelBlock {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 0 12px;
}
#labelBox {
  background: #A6BEEF;
  border: 3px solid #1f3f5c;
  min-height: 70px;
  max-height: 120px;
  padding: 6px;
  color: #000;
  overflow-y: auto;
  font-family: monospace;
  margin: 8px 0;
}
.scan-entry {
  display: block;
  background: #c0d4f5;
  padding: 4px;
  margin: 4px 0;
  border-bottom: 2px solid #2b4b70;
}

#manualInputDiv {
  background: #ffff99;
  border: 2px dashed #ffaa00;
  padding: 5px;
  display: flex;
  align-items: center;
  margin: 4px 0;
}
#manualIndicator {
  background: #ffaa00;
  padding: 2px 8px;
  border-radius: 12px;
  margin-right: 5px;
}

#labelButtons {
  height: 42px;
  background: #7496C4;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border: 2px solid #3a5f8a;
  padding: 0 20px;
  margin: 8px 0;
}
#labelButtons span {
  cursor: pointer;
  padding: 4px 12px;
}
#labelButtons span:active { background: #27ae60; }

#keypadWrapper {
  background: #1f3f5c;
  border-top: 3px solid #ffcc00;
  margin-top: auto;
}
#keyTabs {
  display: flex;
  padding: 8px 12px;
  gap: 8px;
}
#keyTabs button {
  flex: 1;
  background: #3a5f8a;
  border: 2px solid #1f3f5c;
  border-radius: 30px;
  color: #fff;
  padding: 6px 0;
  cursor: pointer;
}
#keyTabs button.active { background: #4CAF50; }

#numericPad {
  display: flex;
  flex-wrap: wrap;
  padding: 6px 12px;
  gap: 6px;
}
#numericPad button {
  width: calc(33.333% - 6px);
  background: #3a5f8a;
  border: 1px solid #1f3f5c;
  border-radius: 6px;
  color: #fff;
  font-size: 26px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 3px 0 #1f3f5c;
}
#numericPad button:active {
  background: #4CAF50;
  transform: translateY(2px);
  box-shadow: 0 1px 0 #1f3f5c;
}

#statusScreen {
  display: none;
  position: absolute;
  top: 38px; left: 0; right: 0; bottom: 0;
  background: #1c3046;
  padding: 20px;
  overflow-y: auto;
}
.statusBtn {
  background: #2b4b70;
  border: 2px solid #ffcc00;
  color: white;
  font-size: 18px;
  padding: 14px;
  margin-bottom: 10px;
  text-align: center;
  border-radius: 8px;
  cursor: pointer;
}
.statusBtn:active { background: #4CAF50; }
.statusBtn.back { background: #1f3f5c; margin-top: 20px; }

#successPopup {
  display: none;
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.7);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
}
.popup-content {
  background: #2b4b70;
  border: 3px solid #27ae60;
  border-radius: 20px;
  padding: 25px;
  width: 260px;
  text-align: center;
}
.checkmark {
  width: 60px; height: 60px;
  background: #27ae60;
  border-radius: 50%;
  font-size: 42px;
  line-height: 60px;
  margin: 0 auto 10px;
}
</style>
</head>
<body>
<div id="phone">
  <div id="header">
    <span>SCAN BARCODE</span>
    <span>
      <span id="gpsIndicator">üåê</span>
      <span id="timeDisplay"></span>
    </span>
  </div>
  
  <div id="scanButton">üì∑ SCAN BARCODE</div>
  
  <div id="scanFrame">
    <video id="preview" autoplay playsinline></video>
    <div id="torchButton">üî¶ FLASH OFF</div>
    <div class="corner-bracket corner-tl"></div>
    <div class="corner-bracket corner-tr"></div>
    <div class="corner-bracket corner-bl"></div>
    <div class="corner-bracket corner-br"></div>
  </div>
  
  <div id="labelBlock">
    <div id="labelBox"></div>
    
    <div id="labelButtons">
      <span id="clearBtn">CLEAR</span>
      <span id="statusBtn">SUBMIT</span>
    </div>
    
    <div id="keypadWrapper">
      <div id="keyTabs">
        <button id="tabNumeric" class="active" onclick="showNumeric()">123</button>
        <button id="tabQwerty" onclick="showQwerty()">ABC</button>
      </div>
      
      <div id="numericPad">
        <button onclick="typeChar('1')">1</button><button onclick="typeChar('2')">2</button><button onclick="typeChar('3')">3</button>
        <button onclick="typeChar('4')">4</button><button onclick="typeChar('5')">5</button><button onclick="typeChar('6')">6</button>
        <button onclick="typeChar('7')">7</button><button onclick="typeChar('8')">8</button><button onclick="typeChar('9')">9</button>
        <button onclick="typeChar('.')">.</button><button onclick="typeChar('0')">0</button>
        <button onclick="backspace()">‚å´</button>
      </div>
      
      <div id="qwertyPad" style="display:none; padding:6px;">
        <div style="display:flex; flex-wrap:wrap; gap:4px;">
          <button onclick="typeChar('q')" style="width:30px">q</button>
          <button onclick="typeChar('w')" style="width:30px">w</button>
          <button onclick="typeChar('e')" style="width:30px">e</button>
          <button onclick="typeChar('r')" style="width:30px">r</button>
          <button onclick="typeChar('t')" style="width:30px">t</button>
          <button onclick="typeChar('y')" style="width:30px">y</button>
          <button onclick="typeChar('u')" style="width:30px">u</button>
          <button onclick="typeChar('i')" style="width:30px">i</button>
          <button onclick="typeChar('o')" style="width:30px">o</button>
          <button onclick="typeChar('p')" style="width:30px">p</button>
          <button onclick="typeChar('a')" style="width:30px">a</button>
          <button onclick="typeChar('s')" style="width:30px">s</button>
          <button onclick="typeChar('d')" style="width:30px">d</button>
          <button onclick="typeChar('f')" style="width:30px">f</button>
          <button onclick="typeChar('g')" style="width:30px">g</button>
          <button onclick="typeChar('h')" style="width:30px">h</button>
          <button onclick="typeChar('j')" style="width:30px">j</button>
          <button onclick="typeChar('k')" style="width:30px">k</button>
          <button onclick="typeChar('l')" style="width:30px">l</button>
          <button onclick="typeChar('z')" style="width:30px">z</button>
          <button onclick="typeChar('x')" style="width:30px">x</button>
          <button onclick="typeChar('c')" style="width:30px">c</button>
          <button onclick="typeChar('v')" style="width:30px">v</button>
          <button onclick="typeChar('b')" style="width:30px">b</button>
          <button onclick="typeChar('n')" style="width:30px">n</button>
          <button onclick="typeChar('m')" style="width:30px">m</button>
          <button onclick="typeChar(' ')" style="width:120px">space</button>
        </div>
      </div>
    </div>
  </div>
  
  <div id="statusScreen">
    <div class="statusBtn" data-status="Received">Data Received</div>
    <div class="statusBtn" data-status="Picked Up">Picked Up</div>
    <div class="statusBtn" data-status="Delivered">Delivered</div>
    <div class="statusBtn back">BACK</div>
  </div>
  
  <div id="successPopup" style="display: none;">
    <div class="popup-content">
      <div class="checkmark">‚úì</div>
      <div id="popupMessage">Success!</div>
    </div>
  </div>
</div>

<script>
(function() {
  // Simple variables
  var scanCount = 0;
  var scans = [];
  var manualInput = '';
  var stream = null;
  var torchOn = false;
  
  // GPS
  function initGPS() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function() {
        document.getElementById('gpsIndicator').innerHTML = 'üìç';
      });
    }
  }
  
  // Time
  function updateTime() {
    document.getElementById('timeDisplay').innerText = new Date().toLocaleTimeString();
  }
  setInterval(updateTime, 1000);
  
  // SIMPLE CAMERA - Guaranteed to work
  function startCamera() {
    var video = document.getElementById('preview');
    var frame = document.getElementById('scanFrame');
    
    frame.style.display = 'block';
    
    // Direct camera access - simplest possible
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: 'environment',
          width: 640,
          height: 480
        } 
      })
      .then(function(s) {
        stream = s;
        video.srcObject = s;
        video.play();
        
        // Start simple detection (just for demo - replace with real barcode detection)
        detectBarcodeSimple();
      })
      .catch(function(err) {
        alert('Camera error: ' + err.message);
        frame.style.display = 'none';
      });
    } else {
      alert('Camera not supported');
    }
  }
  
  // SIMPLE detection - REPLACE this with actual barcode library
  function detectBarcodeSimple() {
    // This is just a demo - in production, use a real barcode library
    // For now, simulate a scan after 5 seconds
    setTimeout(function() {
      if (stream) {
        var fakeCode = 'TEST' + Math.floor(Math.random() * 1000);
        addScan(fakeCode, 'DEMO');
      }
    }, 5000);
  }
  
  // Flashlight
  window.toggleTorch = function() {
    if (!stream) {
      alert('Start camera first');
      return;
    }
    
    torchOn = !torchOn;
    var track = stream.getVideoTracks()[0];
    
    if (track && track.applyConstraints) {
      track.applyConstraints({ advanced: [{ torch: torchOn }] })
        .catch(function(e) { console.log('Torch error'); });
    }
    
    var btn = document.getElementById('torchButton');
    btn.innerHTML = torchOn ? 'üî¶ FLASH ON' : 'üî¶ FLASH OFF';
    btn.className = torchOn ? 'active' : '';
  };
  
  // Add scan
  function addScan(code, type) {
    scanCount++;
    scans.push({
      number: scanCount,
      code: code,
      type: type,
      time: new Date().toISOString()
    });
    
    var box = document.getElementById('labelBox');
    var div = document.createElement('div');
    div.className = 'scan-entry';
    div.innerText = '#' + scanCount + ': ' + code + ' [' + type + ']';
    box.appendChild(div);
  }
  
  // Manual typing
  window.typeChar = function(c) {
    var box = document.getElementById('labelBox');
    var manual = document.getElementById('manualInputDiv');
    
    if (!manual) {
      manual = document.createElement('div');
      manual.id = 'manualInputDiv';
      manual.innerHTML = '<span id="manualIndicator">MAN</span> <span id="manualText"></span>';
      box.appendChild(manual);
    }
    
    manualInput += c;
    document.getElementById('manualText').innerText = manualInput;
  };
  
  window.backspace = function() {
    if (manualInput.length > 0) {
      manualInput = manualInput.slice(0, -1);
      var text = document.getElementById('manualText');
      if (text) {
        text.innerText = manualInput;
        if (!manualInput) {
          document.getElementById('manualInputDiv').remove();
        }
      }
    }
  };
  
  // Submit to XANO - SIMPLIFIED
  window.submitScans = function(status) {
    if (scans.length === 0) {
      alert('No scans');
      return;
    }
    
    var sent = 0;
    
    function sendNext(i) {
      if (i >= scans.length) {
        document.getElementById('popupMessage').innerText = sent + ' of ' + scans.length + ' sent';
        document.getElementById('successPopup').style.display = 'flex';
        setTimeout(function() {
          document.getElementById('successPopup').style.display = 'none';
        }, 2000);
        return;
      }
      
      var scan = scans[i];
      var data = {
        label_id: scan.code,
        barcode_type: scan.type,
        status: status,
        scan_number: scan.number
      };
      
      var xhr = new XMLHttpRequest();
      xhr.open('POST', 'https://x8ki-letl-twmt.n7.xano.io/api:WGx5FQAG/qr_scans', true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      
      xhr.onload = function() {
        if (xhr.status >= 200) sent++;
        sendNext(i + 1);
      };
      
      xhr.onerror = function() {
        sendNext(i + 1);
      };
      
      xhr.send(JSON.stringify(data));
    }
    
    sendNext(0);
  };
  
  // UI functions
  window.showNumeric = function() {
    document.getElementById('numericPad').style.display = 'flex';
    document.getElementById('qwertyPad').style.display = 'none';
    document.getElementById('tabNumeric').className = 'active';
    document.getElementById('tabQwerty').className = '';
  };
  
  window.showQwerty = function() {
    document.getElementById('numericPad').style.display = 'none';
    document.getElementById('qwertyPad').style.display = 'block';
    document.getElementById('tabQwerty').className = 'active';
    document.getElementById('tabNumeric').className = '';
  };
  
  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    initGPS();
    updateTime();
    
    document.getElementById('scanButton').onclick = startCamera;
    document.getElementById('torchButton').onclick = toggleTorch;
    document.getElementById('clearBtn').onclick = function() {
      scans = [];
      scanCount = 0;
      document.getElementById('labelBox').innerHTML = '';
    };
    
    document.getElementById('statusBtn').onclick = function() {
      document.getElementById('labelBlock').style.display = 'none';
      document.getElementById('scanButton').style.display = 'none';
      document.getElementById('statusScreen').style.display = 'block';
    };
    
    var backs = document.querySelectorAll('.statusBtn.back');
    for (var i = 0; i < backs.length; i++) {
      backs[i].onclick = function() {
        document.getElementById('statusScreen').style.display = 'none';
        document.getElementById('labelBlock').style.display = 'flex';
        document.getElementById('scanButton').style.display = 'flex';
      };
    }
    
    var statusBtns = document.querySelectorAll('.statusBtn[data-status]');
    for (var i = 0; i < statusBtns.length; i++) {
      statusBtns[i].onclick = function() {
        var status = this.getAttribute('data-status');
        window.submitScans(status);
      };
    }
  });
  
})();
</script>
</body>
</html>
