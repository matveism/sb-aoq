<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>QR MAX ¬∑ UNIVERSAL</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { 
  background:#000; 
  font-family:'Segoe UI',Tahoma,Arial,sans-serif;
  font-weight:bold;
  height:100%;
  overflow:hidden;
  -webkit-user-select:none;
  user-select:none;
}
#phone {
  max-width:480px;
  margin:0 auto;
  height:100%;
  background:#2b4b70;
  display:flex;
  flex-direction:column;
  color:white;
  position:relative;
}
.header {
  background:#1f3f5c;
  padding:8px 12px;
  display:flex;
  justify-content:space-between;
  font-size:14px;
  border-bottom:2px solid #ffcc00;
}
.flash-btn {
  background:#ffcc00;
  color:#000;
  padding:2px 8px;
  border-radius:4px;
  font-weight:bold;
  cursor:pointer;
}
.scan-btn {
  background:#4CAF50;
  margin:10px;
  padding:15px;
  text-align:center;
  font-size:18px;
  border-radius:8px;
  border:2px solid #1e5a22;
  box-shadow:0 4px 0 #145018;
  cursor:pointer;
  font-weight:bold;
}
.scan-btn:active {
  transform:translateY(4px);
  box-shadow:none;
}
#preview-container {
  margin:0 auto 10px;
  width:280px;
  height:140px;
  border:3px solid #ffcc00;
  position:relative;
  display:none;
  background:#000;
}
#preview {
  width:100%;
  height:100%;
  object-fit:cover;
}
.laser {
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:2px;
  background:red;
  animation:scan 1.5s infinite;
  display:none;
}
@keyframes scan {
  0% { top:0; }
  50% { top:138px; }
  100% { top:0; }
}
.corner {
  position:absolute;
  width:15px;
  height:15px;
  border:2px solid #ffcc00;
}
.tl { top:-2px; left:-2px; border-right:none; border-bottom:none; }
.tr { top:-2px; right:-2px; border-left:none; border-bottom:none; }
.bl { bottom:-2px; left:-2px; border-right:none; border-top:none; }
.br { bottom:-2px; right:-2px; border-left:none; border-top:none; }
.data-area {
  flex:1;
  margin:10px;
  background:#A6BEEF;
  border:3px solid #1f3f5c;
  padding:8px;
  color:#000;
  overflow-y:auto;
  max-height:120px;
  font-size:12px;
}
.data-item {
  background:#c0d4f5;
  margin:3px 0;
  padding:4px;
  border-radius:4px;
  border-bottom:2px solid #2b4b70;
  word-break:break-all;
}
.controls {
  display:flex;
  justify-content:space-between;
  margin:5px 10px;
}
.controls button {
  background:#4a7aa8;
  border:2px solid #1f3f5c;
  color:white;
  font-weight:bold;
  padding:8px 20px;
  border-radius:4px;
  cursor:pointer;
}
.controls button:active { background:#4CAF50; }
.keyboard-tabs {
  display:flex;
  margin:5px 10px;
  gap:5px;
}
.keyboard-tabs button {
  flex:1;
  background:#3a5f8a;
  border:2px solid #1f3f5c;
  color:white;
  font-weight:bold;
  padding:8px;
  border-radius:20px;
  cursor:pointer;
}
.keyboard-tabs button.active { background:#4CAF50; }
.keypad {
  background:#1f3f5c;
  padding:10px;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:5px;
}
.keypad button {
  background:#5a7a9a;
  border:2px solid #2b4b70;
  color:white;
  font-weight:bold;
  font-size:18px;
  padding:12px;
  border-radius:6px;
  cursor:pointer;
}
.keypad button:active { background:#4CAF50; }
.keypad .backspace { background:#3a5f8a; }
.qwerty, .symbols {
  display:none;
  padding:10px;
  background:#1f3f5c;
}
.row {
  display:flex;
  gap:3px;
  margin-bottom:3px;
}
.row button {
  flex:1;
  max-width:30px;
  background:#5a7a9a;
  border:2px solid #2b4b70;
  color:white;
  font-weight:bold;
  padding:8px;
  border-radius:4px;
  cursor:pointer;
}
.row button.special { max-width:44px; background:#3a5f8a; }
.row button.space { max-width:160px; flex:3; }
#status-screen {
  display:none;
  position:absolute;
  top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.9);
  padding:20px;
  overflow-y:auto;
  z-index:999;
}
.status-item {
  background:#2b4b70;
  border:2px solid #ffcc00;
  padding:15px;
  margin-bottom:10px;
  border-radius:8px;
  text-align:center;
}
#popup {
  display:none;
  position:absolute;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  background:#2b4b70;
  border:3px solid #4CAF50;
  padding:20px;
  border-radius:15px;
  text-align:center;
  z-index:1000;
  width:250px;
}
.error {
  color:#ff6b6b;
  text-align:center;
  margin:10px;
  display:none;
}
#scan-count {
  font-size:14px;
}
</style>
</head>
<body>
<div id="phone">
  <div class="header">
    <span>QR SCANNER</span>
    <span><span id="flashBtn" class="flash-btn" onclick="toggleFlash()">üî¶</span> <span id="time"></span></span>
  </div>
  
  <div class="scan-btn" onclick="toggleScan()" id="scanBtn">START SCAN</div>
  <div class="error" id="errorMsg"></div>
  
  <div id="preview-container">
    <video id="preview" autoplay muted playsinline></video>
    <div class="laser" id="laser"></div>
    <div class="corner tl"></div>
    <div class="corner tr"></div>
    <div class="corner bl"></div>
    <div class="corner br"></div>
  </div>
  
  <div class="data-area" id="dataBox"></div>
  
  <div class="controls">
    <button onclick="clearLast()">‚å´</button>
    <button onclick="newLine()">‚Üµ ENTER</button>
    <button onclick="showStatus()">üìã</button>
  </div>
  
  <div class="keyboard-tabs">
    <button class="active" onclick="showKeyboard('abc')">ABC</button>
    <button onclick="showKeyboard('123')">123</button>
    <button onclick="showKeyboard('sym')">SYM</button>
  </div>
  
  <!-- Numeric Keypad -->
  <div id="numPad" class="keypad">
    <button onclick="addChar('1')">1</button>
    <button onclick="addChar('2')">2</button>
    <button onclick="addChar('3')">3</button>
    <button onclick="addChar('4')">4</button>
    <button onclick="addChar('5')">5</button>
    <button onclick="addChar('6')">6</button>
    <button onclick="addChar('7')">7</button>
    <button onclick="addChar('8')">8</button>
    <button onclick="addChar('9')">9</button>
    <button onclick="addChar('.')">.</button>
    <button onclick="addChar('0')">0</button>
    <button class="backspace" onclick="backspace()">‚å´</button>
  </div>
  
  <!-- QWERTY -->
  <div id="abcPad" class="qwerty" style="display:block;">
    <div class="row">
      <button onclick="addChar('q')">q</button><button onclick="addChar('w')">w</button><button onclick="addChar('e')">e</button>
      <button onclick="addChar('r')">r</button><button onclick="addChar('t')">t</button><button onclick="addChar('y')">y</button>
      <button onclick="addChar('u')">u</button><button onclick="addChar('i')">i</button><button onclick="addChar('o')">o</button>
      <button onclick="addChar('p')">p</button>
    </div>
    <div class="row">
      <button onclick="addChar('a')">a</button><button onclick="addChar('s')">s</button><button onclick="addChar('d')">d</button>
      <button onclick="addChar('f')">f</button><button onclick="addChar('g')">g</button><button onclick="addChar('h')">h</button>
      <button onclick="addChar('j')">j</button><button onclick="addChar('k')">k</button><button onclick="addChar('l')">l</button>
    </div>
    <div class="row">
      <button onclick="addChar('z')">z</button><button onclick="addChar('x')">x</button><button onclick="addChar('c')">c</button>
      <button onclick="addChar('v')">v</button><button onclick="addChar('b')">b</button><button onclick="addChar('n')">n</button>
      <button onclick="addChar('m')">m</button>
      <button class="special" onclick="backspace()">‚å´</button>
    </div>
    <div class="row">
      <button class="special" onclick="showKeyboard('123')">123</button>
      <button class="space" onclick="addChar(' ')">space</button>
      <button class="special" onclick="addChar('.')">.</button>
    </div>
  </div>
  
  <!-- Symbols -->
  <div id="symPad" class="symbols">
    <div class="row">
      <button onclick="addChar('@')">@</button><button onclick="addChar('#')">#</button><button onclick="addChar('$')">$</button>
      <button onclick="addChar('%')">%</button><button onclick="addChar('&')">&</button><button onclick="addChar('*')">*</button>
      <button onclick="addChar('(')">(</button><button onclick="addChar(')')">)</button>
    </div>
    <div class="row">
      <button onclick="addChar('!')">!</button><button onclick="addChar('?')">?</button><button onclick="addChar('/')">/</button>
      <button onclick="addChar(':')">:</button><button onclick="addChar(';')">;</button><button onclick="addChar('"')">"</button>
      <button onclick="addChar("'")">'</button><button onclick="addChar(',')">,</button>
    </div>
    <div class="row">
      <button onclick="addChar('-')">-</button><button onclick="addChar('+')">+</button><button onclick="addChar('=')">=</button>
      <button onclick="addChar('<')">&lt;</button><button onclick="addChar('>')">&gt;</button><button onclick="addChar('[')">[</button>
      <button onclick="addChar(']')">]</button><button class="special" onclick="backspace()">‚å´</button>
    </div>
    <div class="row">
      <button class="special" onclick="showKeyboard('abc')">ABC</button>
      <button class="space" onclick="addChar(' ')">space</button>
      <button class="special" onclick="addChar('.')">.</button>
    </div>
  </div>
  
  <!-- Status Screen -->
  <div id="status-screen">
    <div class="status-item">üì¶ Data Received (+7d)</div>
    <div class="status-item">üöö Picked Up (-1d)</div>
    <div class="status-item">üè¢ Depart Post (-2d)</div>
    <div class="status-item">üìç Arrival Scan (-0.5d)</div>
    <div class="status-item">üè† Local Scan (-1.5d)</div>
    <div class="status-item">üöõ Out For Delivery (-2d)</div>
    <div class="status-item">‚úÖ Delivered (0d)</div>
    <button style="width:100%; padding:15px; background:#4CAF50; border:none; color:white; font-weight:bold; margin-top:20px;" onclick="hideStatus()">BACK</button>
  </div>
  
  <!-- Popup -->
  <div id="popup">
    <div style="font-size:30px; color:#4CAF50;">‚úì</div>
    <div style="font-size:16px; margin:10px 0;">QR Code Recorded!</div>
    <div id="popupData" style="font-size:12px; color:#ffcc00;"></div>
  </div>
</div>

<!-- Ultra lightweight QR decoder from jsQR (minimal) -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
// ===== UNIVERSAL COMPATIBLE CODE =====
// Works on: Android 2.3+, Windows CE, IE6+, XP

var scanning = false;
var videoStream = null;
var scanData = [];
var scanTimer = null;
var flashSupported = false;
var torchActive = false;

// Time update
function updateClock() {
  var d = new Date();
  var h = d.getHours();
  var m = d.getMinutes();
  var ampm = h >= 12 ? 'PM' : 'AM';
  h = h % 12 || 12;
  document.getElementById('time').innerHTML = h + ':' + (m < 10 ? '0' : '') + m + ' ' + ampm;
}
updateClock();
setInterval(updateClock, 60000);

// Keyboard switching
function showKeyboard(type) {
  var tabs = document.querySelectorAll('.keyboard-tabs button');
  for(var i=0; i<tabs.length; i++) tabs[i].className = '';
  
  document.getElementById('numPad').style.display = 'none';
  document.getElementById('abcPad').style.display = 'none';
  document.getElementById('symPad').style.display = 'none';
  
  if(type === '123') {
    document.getElementById('numPad').style.display = 'grid';
    tabs[1].className = 'active';
  } else if(type === 'abc') {
    document.getElementById('abcPad').style.display = 'block';
    tabs[0].className = 'active';
  } else {
    document.getElementById('symPad').style.display = 'block';
    tabs[2].className = 'active';
  }
}

// Data management
function renderData() {
  var html = '';
  for(var i=0; i<scanData.length; i++) {
    html += '<div class="data-item">' + escapeHTML(scanData[i]) + '</div>';
  }
  document.getElementById('dataBox').innerHTML = html;
  document.getElementById('dataBox').scrollTop = document.getElementById('dataBox').scrollHeight;
}

function escapeHTML(str) {
  if(!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function addChar(c) {
  if(scanData.length === 0) scanData.push('');
  scanData[scanData.length-1] += c;
  renderData();
}

function backspace() {
  if(scanData.length === 0) return;
  var last = scanData[scanData.length-1];
  if(last.length <= 1) {
    scanData.pop();
  } else {
    scanData[scanData.length-1] = last.slice(0, -1);
  }
  renderData();
}

function newLine() {
  if(scanData.length === 0 || scanData[scanData.length-1] !== '') {
    scanData.push('');
    renderData();
  }
}

function clearLast() {
  backspace();
}

// Camera functions
function toggleScan() {
  if(scanning) {
    stopScan();
  } else {
    startScan();
  }
}

function startScan() {
  var errorMsg = document.getElementById('errorMsg');
  errorMsg.style.display = 'none';
  errorMsg.innerHTML = '';
  
  var container = document.getElementById('preview-container');
  var video = document.getElementById('preview');
  var laser = document.getElementById('laser');
  
  container.style.display = 'block';
  
  // MOST COMPATIBLE CAMERA ACCESS - works on everything
  var constraints = { video: true };
  
  // Try modern API first
  if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: 'environment' } } })
    .then(handleSuccess)
    .catch(function() {
      // Fallback to any camera
      navigator.mediaDevices.getUserMedia({ video: true })
      .then(handleSuccess)
      .catch(fallbackToOldAPI);
    });
  } else {
    fallbackToOldAPI();
  }
  
  function handleSuccess(stream) {
    videoStream = stream;
    
    // For modern browsers
    if(video.srcObject !== undefined) {
      video.srcObject = stream;
    } else {
      // For older browsers
      video.src = window.URL.createObjectURL(stream);
    }
    
    video.play();
    laser.style.display = 'block';
    scanning = true;
    document.getElementById('scanBtn').innerHTML = 'STOP SCAN';
    
    // Check for flash
    checkFlashSupport();
    
    // Start scanning loop
    scanTimer = setInterval(scanQR, 300); // 3-4 fps for performance
  }
  
  function fallbackToOldAPI() {
    // Universal fallback for Android 2.3, IE, old browsers
    var getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
    
    if(getUserMedia) {
      getUserMedia.call(navigator, { video: true }, handleSuccess, function(err) {
        errorMsg.innerHTML = 'Camera access denied';
        errorMsg.style.display = 'block';
        container.style.display = 'none';
      });
    } else {
      errorMsg.innerHTML = 'Camera not supported';
      errorMsg.style.display = 'block';
      container.style.display = 'none';
    }
  }
}

function stopScan() {
  scanning = false;
  if(scanTimer) clearInterval(scanTimer);
  
  if(videoStream) {
    if(videoStream.stop) {
      videoStream.stop();
    } else if(videoStream.getTracks) {
      videoStream.getTracks().forEach(function(track) { track.stop(); });
    }
    videoStream = null;
  }
  
  var video = document.getElementById('preview');
  if(video) {
    video.pause();
    video.src = '';
    if(video.srcObject) video.srcObject = null;
  }
  
  document.getElementById('preview-container').style.display = 'none';
  document.getElementById('laser').style.display = 'none';
  document.getElementById('scanBtn').innerHTML = 'START SCAN';
  torchActive = false;
  document.getElementById('flashBtn').innerHTML = 'üî¶';
}

function checkFlashSupport() {
  if(videoStream && videoStream.getVideoTracks) {
    var track = videoStream.getVideoTracks()[0];
    if(track && track.getCapabilities) {
      var capabilities = track.getCapabilities();
      if(capabilities && capabilities.torch) {
        flashSupported = true;
      }
    }
  }
}

function toggleFlash() {
  if(!videoStream || !scanning) {
    alert('Start scanner first');
    return;
  }
  
  var track = videoStream.getVideoTracks ? videoStream.getVideoTracks()[0] : null;
  
  if(!track) return;
  
  torchActive = !torchActive;
  
  if(track.applyConstraints) {
    try {
      track.applyConstraints({ advanced: [{ torch: torchActive }] });
      document.getElementById('flashBtn').innerHTML = torchActive ? 'üî¶‚ú®' : 'üî¶';
    } catch(e) {
      alert('Flash not available');
    }
  } else {
    // Try legacy torch method
    try {
      track.torch = torchActive;
      document.getElementById('flashBtn').innerHTML = torchActive ? 'üî¶‚ú®' : 'üî¶';
    } catch(e) {
      alert('Flash not supported');
    }
  }
}

function scanQR() {
  if(!scanning) return;
  
  var video = document.getElementById('preview');
  if(!video || video.readyState < 2 || video.videoWidth === 0) return;
  
  // Create temporary canvas
  var canvas = document.createElement('canvas');
  canvas.width = 320;
  canvas.height = 240;
  var ctx = canvas.getContext('2d');
  
  try {
    ctx.drawImage(video, 0, 0, 320, 240);
    var imageData = ctx.getImageData(0, 0, 320, 240);
    
    var code = jsQR(imageData.data, 320, 240, {
      inversionAttempts: 'dontInvert'
    });
    
    if(code && code.data && code.data.length > 0) {
      // Success!
      stopScan();
      scanData.push(code.data);
      renderData();
      showPopup(code.data);
    }
  } catch(e) {
    // Silent fail
  }
}

function showPopup(data) {
  var popup = document.getElementById('popup');
  document.getElementById('popupData').innerHTML = data.length > 30 ? data.substr(0,30)+'...' : data;
  popup.style.display = 'block';
  setTimeout(function() { popup.style.display = 'none'; }, 2000);
}

function showStatus() {
  document.getElementById('status-screen').style.display = 'block';
}

function hideStatus() {
  document.getElementById('status-screen').style.display = 'none';
}

// Initialize
showKeyboard('abc');
scanData = [];
renderData();

// Make sure flash button exists
if(!document.getElementById('flashBtn')) {
  // Add it dynamically if needed
}
</script>
</body>
</html>
