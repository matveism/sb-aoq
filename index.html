<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>UNIVERSAL BARCODE SCANNER ¬∑ 1D/2D</title>

<style>
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
body { margin:0; padding:0; background:#000; display:flex; justify-content:center; align-items:center; min-height:100vh; font-family:'Roboto','Segoe UI',Arial,sans-serif; font-weight:700; }
#phone { width:360px; height:640px; background:linear-gradient(180deg,#3f6b9c 0%,#2b4b70 100%); color:#fff; position:relative; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 10px 25px rgba(0,0,0,0.5); }
#header { width:100%; height:38px; background:linear-gradient(180deg,#5180b0 0%,#2e5a88 100%); border-bottom:2px solid #1f3f5c; display:flex; justify-content:space-between; align-items:center; padding:0 12px; font-weight:700; font-size:16px; z-index:2; flex-shrink:0; letter-spacing:0.3px; }
#leftText{color:#fff;} #rightArea{color:#fff;font-size:14px;display:flex;align-items:center;gap:8px;}
#gpsIndicator{color:#4CAF50;font-size:16px;}
#timeDisplay{color:#ffcc00;font-size:14px;}
#scanButton { width:calc(100% - 24px); height:50px; background:linear-gradient(180deg,#4CAF50 0%,#2b6e2f 100%); border:2px solid #1e5a22; color:#fff; font-size:22px; font-weight:700; text-align:center; line-height:48px; margin:12px auto 8px auto; border-radius:6px; z-index:2; box-shadow:0 4px 0 #145018; cursor:pointer; flex-shrink:0; display:flex; align-items:center; justify-content:center; gap:8px; letter-spacing:0.5px; }
#scanButton:active { transform:translateY(2px); box-shadow:0 2px 0 #145018; }
.scan-button{display:flex;align-items:center;gap:6px;font-family:Arial;font-size:14px;}
.icon{width:16px;height:12px;background:repeating-linear-gradient(to right, black, black 2px, white 2px, white 4px);}
#scanFrame { width:280px; height:160px; margin:4px auto 0 auto; position:relative; display:none; z-index:3; overflow:hidden; flex-shrink:0; background:rgba(0,0,0,0.4); border: none; } /* no outer border, inner corners only */
#preview { width:100%; height:100%; object-fit:cover; display:block; }

/* STATIC YELLOW CORNER BRACKETS (mini rectangles) - NO LASER */
.corner-bracket {
    position: absolute;
    width: 28px;
    height: 28px;
    border: 4px solid #ffcc00;  /* solid yellow */
    filter: drop-shadow(0 0 5px rgba(255,204,0,0.7));
    pointer-events: none;
    z-index: 10;
}
/* each corner only shows two borders to create brackets */
.corner-tl { top: 4px; left: 4px; border-right: none; border-bottom: none; }
.corner-tr { top: 4px; right: 4px; border-left: none; border-bottom: none; }
.corner-bl { bottom: 4px; left: 4px; border-right: none; border-top: none; }
.corner-br { bottom: 4px; right: 4px; border-left: none; border-top: none; }

#labelBlock { display:flex; flex-direction:column; flex:1; min-height:0; width:100%; z-index:2; margin-top:4px; }
#labelTitle { height:32px; background:linear-gradient(180deg,#3f6b9c 0%,#2b4b70 100%); border:1px solid #1f3f5c; display:flex; align-items:center; padding-left:12px; margin:0 12px; font-weight:700; font-size:14px; color:#fff; flex-shrink:0; letter-spacing:0.5px; }
#labelBox { width:calc(100% - 24px); min-height:80px; max-height:120px; margin:0 auto; border:3px solid #1f3f5c; background:#A6BEEF; padding:8px 10px; font-size:16px; font-weight:700; color:#000; white-space:pre-wrap; overflow-y:auto; word-break:break-all; flex-shrink:0; line-height:1.5; font-family:'Roboto','Segoe UI',monospace; box-shadow:inset 0 0 0 2px #fff; }
#labelBox span.scan-entry { display:block; border-bottom:2px solid #2b4b70; background:#c0d4f5; padding:4px 6px; margin:4px 0; border-radius:4px; font-weight:700; color:#000; }
#labelBox span.scan-entry:last-child{border-bottom:none;}
#manualInputDiv { background:#ffff99; border:2px dashed #ffaa00; border-radius:4px; padding:6px; margin:4px 0; font-weight:bold; color:#000; display:flex; align-items:center; gap:6px; }
#manualIndicator { background:#ffaa00; color:#000; padding:2px 8px; border-radius:12px; font-size:12px; }
#manualText { flex:1; font-family:monospace; letter-spacing:1px; color:#0066cc; }
#labelButtons { height:42px; background:#7496C4; display:flex; align-items:center; justify-content:space-between; border-radius:4px; border:2px solid #3a5f8a; margin:8px 12px 0 12px; padding:0 20px; font-weight:700; font-size:18px; color:#fff; flex-shrink:0; box-shadow:inset 0 -2px 0 #3a5f8a; }
#labelButtons span { cursor:pointer; padding:4px 12px; background:transparent; text-shadow:1px 1px 0 #1f3f5c; }
#labelButtons span:active { background:#27ae60; border-radius:4px; }
#divider { color: rgba(255,255,255,0.7); padding:0 !important; }
#navBar { height:36px; background:linear-gradient(180deg,#4a7aa8 0%,#2b4b70 100%); display:flex; align-items:center; justify-content:space-between; border-radius:4px; border:1px solid #1f3f5c; margin:8px 12px 0 12px; padding:0 16px; font-weight:700; font-size:14px; color:#fff; flex-shrink:0; }
#navBar button { background:transparent; border:none; color:white; font-size:20px; font-weight:700; cursor:pointer; padding:4px 8px; }
#navBar button:active { color:#4CAF50; }
#keypadWrapper { width:100%; background:linear-gradient(180deg,#2b4b70 0%,#1f3f5c 100%); border-top:3px solid #ffcc00; margin-top:auto; flex-shrink:0; z-index:2; padding-bottom:4px; }
#keyTabs{display:flex; gap:8px; padding:8px 12px 4px 12px;} 
#keyTabs button{flex:1; background:#3a5f8a; border:2px solid #1f3f5c; border-radius:30px; color:#fff; font-size:14px; font-weight:700; padding:8px 0; cursor:pointer;}
#keyTabs button.active{background:#4CAF50; border-color:#145018;}
#keyTabs button:active{background:#66BB6A;}
#numericPad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:6px 15px 10px 15px;}
#numericPad button{background:linear-gradient(180deg,#5a7a9a 0%,#3a5f8a 100%); border:1px solid #1f3f5c; border-radius:6px;color:#fff; font-size:22px; font-weight:700; height:48px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 3px 0 #1f3f5c;}
#numericPad button:active{transform:translateY(2px); background:#4CAF50;}
#numericPad button.backspace{background:linear-gradient(180deg,#3a5f8a 0%,#2b4b70 100%);}
#qwertyPad, #symbolPad{display:none; padding:0 8px 12px 8px;}
.row{display:flex; gap:4px; margin-bottom:4px; justify-content:center;}
.row button{flex:1; max-width:32px; background:linear-gradient(180deg,#5a7a9a 0%,#3a5f8a 100%); border:1px solid #1f3f5c; border-radius:6px; color:#fff; font-size:16px; font-weight:700; height:40px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 0 #1f3f5c;}
.row button:active{transform:translateY(2px); background:#4CAF50;}
.row button.special{background:linear-gradient(180deg,#3a5f8a 0%,#2b4b70 100%); max-width:50px;}
.row button.space{flex:3; max-width:200px;}
#statusScreen{display:none; flex-direction:column; position:absolute; top:38px; left:0; right:0; bottom:0; background:rgba(28,48,70,0.98); z-index:100; padding:20px 16px; overflow-y:auto; gap:10px;}
.statusBtn{background:linear-gradient(180deg,#3f6b9c 0%,#2b4b70 100%); border:2px solid #ffcc00; color:white; font-size:18px; font-weight:700; padding:16px 8px; text-align:center; border-radius:8px; cursor:pointer;}
.statusBtn:active{background:#4CAF50;}
.statusBtn.back{background:linear-gradient(180deg,#3a5f8a 0%,#1f3f5c 100%); border-color:#f1c40f; margin-top:25px;}
#successPopup{display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center;}
.popup-content{background:linear-gradient(180deg,#3f6b9c 0%,#2b4b70 100%); border:3px solid #27ae60; border-radius:20px; padding:30px 20px; text-align:center; width:280px; animation:fadePop 0.2s;}
.checkmark{width:70px;height:70px;background:#27ae60;border-radius:50%; font-size:48px; display:flex; align-items:center; justify-content:center; margin:0 auto 15px auto; color:white;}
.popup-message{font-size:20px; font-weight:700;}
.popup-submessage{color:#ffcc00;font-size:15px;margin-top:5px;}
.eta-info{color:#4CAF50;font-size:14px;margin-top:10px;border-top:1px solid #fff;padding-top:10px;}
@keyframes fadePop{0%{opacity:0;transform:scale(0.7);}100%{opacity:1;transform:scale(1);}}
#labelBox::-webkit-scrollbar{width:4px;} 
#labelBox::-webkit-scrollbar-thumb{background:#1f3f5c;}
#barcodeType{font-size:10px;color:#ffcc00;margin-left:5px;font-weight:normal;}
#errorMessage{color:#ff4444;text-align:center;padding:10px;font-size:14px;display:none;}
</style>

<!-- jsQR (good for 1D and 2D) -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<!-- axios for reverse geocoding -->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
(function(){
let stream=null, scanning=false, scanCount=0, animationFrame=null, currentScans=[], currentLocation=null, gpsWatchId=null;
let manualInput = ''; 
let isSubmitting = false;

// --------- XANO ENDPOINT (UNIVERSAL BARCODE SCANS) ---------
const XANO_URL = 'https://x8ki-letl-twmt.n7.xano.io/api:WGx5FQAG/qr_scans'; 
//------------------------------------------------------

let audioCtx=null;

function playBeep(){
  try{
    if(!audioCtx){audioCtx=new (window.AudioContext||window.webkitAudioContext)();}
    if(audioCtx.state==='suspended'){audioCtx.resume().then(()=>{createAndPlayBeep(audioCtx);}).catch(e=>console.warn(e));}else{createAndPlayBeep(audioCtx);}
  }catch(e){console.warn(e);}
}

function createAndPlayBeep(ctx){
  const now=ctx.currentTime;
  const osc=ctx.createOscillator();
  const gain=ctx.createGain();
  osc.type='sine';
  osc.frequency.value=880;
  gain.gain.setValueAtTime(0.3,now);
  gain.gain.exponentialRampToValueAtTime(0.01,now+0.15);
  osc.connect(gain).connect(ctx.destination);
  osc.start(now);
  osc.stop(now+0.15);
}

async function getCityStateFromCoords(lat, lng) {
  try {
    console.log(`üìç reverse geocode: ${lat}, ${lng}`);
    const response = await axios.get(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`, {
      headers: { 'User-Agent': 'UniversalBarcodeScanner/2.0' }
    });
    if (response.data && response.data.address) {
      const address = response.data.address;
      const city = address.city || address.town || address.village || address.hamlet || 'Unknown';
      const state = address.state || address.state_code || 'XX';
      const zip = address.postcode || '00000';
      const country = address.country || '';
      return { city, state, zip, country, display_name: response.data.display_name || `${city}, ${state} ${zip}` };
    }
  } catch (error) {
    console.error('Geocode error:', error);
  }
  return { city: 'Unknown', state: 'XX', zip: '00000', country: '', display_name: `${lat.toFixed(4)}, ${lng.toFixed(4)}` };
}

function initGPS(){
  if(navigator.geolocation){
    console.log('üì° Requesting GPS for scan gun...');
    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        currentLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude, accuracy: pos.coords.accuracy, timestamp: new Date().toISOString() };
        const locationData = await getCityStateFromCoords(pos.coords.latitude, pos.coords.longitude);
        currentLocation.address = locationData;
        console.log(`üìç Warehouse location: ${locationData.display_name}`);
        updateGPSIndicator(true, locationData);
      },
      (err) => {
        console.warn('GPS error:', err.message);
        updateGPSIndicator(false);
        alert(`‚ö†Ô∏è GPS needed for location stamps. Please enable location.`);
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
    gpsWatchId = navigator.geolocation.watchPosition(
      async (pos) => {
        currentLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude, accuracy: pos.coords.accuracy, timestamp: new Date().toISOString() };
        const locationData = await getCityStateFromCoords(pos.coords.latitude, pos.coords.longitude);
        currentLocation.address = locationData;
        updateGPSIndicator(true, locationData);
      },
      (err) => { updateGPSIndicator(false); },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  } else {
    updateGPSIndicator(false);
    alert('Geolocation not supported.');
  }
}

function updateGPSIndicator(hasGPS, locationData = null){
  const gps = document.getElementById('gpsIndicator');
  if (hasGPS && locationData) {
    gps.innerHTML = 'üìç';
    gps.style.color = '#4CAF50';
    gps.title = `${locationData.city}, ${locationData.state} ${locationData.zip}`;
  } else if (hasGPS) {
    gps.innerHTML = 'üõ∞Ô∏è';
    gps.style.color = '#4CAF50';
    gps.title = 'GPS connected';
  } else {
    gps.innerHTML = 'üåê';
    gps.style.color = '#ff4444';
    gps.title = 'GPS unavailable';
  }
}

function updateTime(){
  const d=new Date();
  const month=(d.getMonth()+1).toString().padStart(2,'0');
  const day=d.getDate().toString().padStart(2,'0');
  const hours=d.getHours();
  const minutes=d.getMinutes().toString().padStart(2,'0');
  const ampm=hours>=12?'PM':'AM';
  const hour12=hours%12||12;
  const timeStr=month+'/'+day+' '+hour12+':'+minutes+' '+ampm;
  document.getElementById('timeDisplay').innerText=timeStr;
  document.getElementById('timeDisplay2').innerText=timeStr;
}
setInterval(updateTime,1000);

function stopCamera(){
  if(animationFrame){cancelAnimationFrame(animationFrame);animationFrame=null;}
  if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;} 
  scanning=false;
}

async function startScan(){
  if(scanning){stopCamera();return;} 
  scanning=true;
  const frame=document.getElementById('scanFrame');
  // Laser element removed; we use static corner brackets (already in HTML)
  frame.style.display='block';
  
  try{
    if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){
      throw new Error('Browser does not support camera');
    }
    stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:'environment',width:{min:360,ideal:640,max:1280},height:{min:240,ideal:480,max:720}}
    });
    const video=document.getElementById('preview');
    video.srcObject=stream;
    await new Promise(resolve=>{video.onloadedmetadata=()=>{video.play().then(resolve);};});
    
    const canvas=document.createElement('canvas');
    const ctx=canvas.getContext('2d', { willReadFrequently: true });
    
    function scanFrame(){
      if(!scanning||!video.videoWidth){
        animationFrame=requestAnimationFrame(scanFrame);
        return;
      }
      canvas.width=video.videoWidth;
      canvas.height=video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      // jsQR detects both 1D (if formatted) and 2D codes. It's quite robust.
      const code=jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data,canvas.width,canvas.height,{inversionAttempts:"dontInvert"});
      if(code){
        // Determine format hint: if it's numeric and length typical, label as UPC/A, else as detected format or 'CODE'
        let detectedType = code.format ? code.format : '1D/2D';
        // Improve type guessing: if code.data matches UPC pattern (12 digits) maybe label as UPC
        if(/^\d{12,13}$/.test(code.data)) detectedType = 'UPC-A/EAN';
        else if(/^[0-9]+$/.test(code.data) && code.data.length > 5) detectedType = '1D (numeric)';
        else if(code.data.length > 0) detectedType = '2D/QR';
        
        onBarcodeDecoded(code.data, detectedType);
        return;
      } 
      animationFrame=requestAnimationFrame(scanFrame);
    }
    animationFrame=requestAnimationFrame(scanFrame);
  }catch(err){
    console.error(err);
    scanning=false;
    frame.style.display='none';
    alert('Camera error: ' + (err.message||''));
  }
}

function onBarcodeDecoded(code, type){
  scanning=false;
  stopCamera();
  document.getElementById('scanFrame').style.display='none';
  playBeep();
  
  scanCount++;
  currentScans.push({number:scanCount, code, type, timestamp:new Date().toISOString(), location:currentLocation});
  
  const box=document.getElementById('labelBox');
  
  // Clear manual display when scanned
  manualInput = '';
  const manualDiv = document.getElementById('manualInputDiv');
  if(manualDiv) manualDiv.remove();
  
  const locationText = currentLocation?.address ? 
    ` üìç ${currentLocation.address.city}, ${currentLocation.address.state}` : 
    (currentLocation ? ' üìç' : '');
  
  const span=document.createElement('span');
  span.className='scan-entry';
  span.innerHTML = 'üì¶ SCAN #' + scanCount + ': ' + code + locationText + '<span id="barcodeType"> ['+type+']</span>';
  box.appendChild(span);
  box.scrollTop=box.scrollHeight;
}

function clearScans(){
  scanCount=0;
  currentScans=[];
  manualInput = '';
  const box = document.getElementById('labelBox');
  box.innerHTML='';
  const manualDiv = document.getElementById('manualInputDiv');
  if(manualDiv) manualDiv.remove();
}

function goToStatus(){
  // Add manual input as a scan if present
  if(manualInput.trim() !== '') {
    scanCount++;
    currentScans.push({
      number: scanCount,
      code: manualInput.trim(),
      type: 'MANUAL-ENTRY',
      timestamp: new Date().toISOString(),
      location: currentLocation
    });
    
    const box = document.getElementById('labelBox');
    const span = document.createElement('span');
    const locationText = currentLocation?.address ? 
      ` üìç ${currentLocation.address.city}, ${currentLocation.address.state}` : 
      (currentLocation ? ' üìç' : '');
    span.className = 'scan-entry';
    span.innerHTML = '‚úèÔ∏è MANUAL #' + scanCount + ': ' + manualInput.trim() + locationText + '<span id="barcodeType"> [MANUAL]</span>';
    box.appendChild(span);
    
    manualInput = '';
    const manualDiv = document.getElementById('manualInputDiv');
    if(manualDiv) manualDiv.remove();
  }
  
  if(currentScans.length===0){
    alert('Scan a barcode or type one first');
    return;
  }
  
  document.getElementById('labelBlock').style.display='none';
  document.getElementById('scanButton').style.display='none';
  document.getElementById('leftText').innerText='SELECT STATUS';
  document.getElementById('statusScreen').style.display='flex';
}

function goBackToScan(){
  document.getElementById('statusScreen').style.display='none';
  document.getElementById('labelBlock').style.display='flex';
  document.getElementById('scanButton').style.display='flex';
  document.getElementById('leftText').innerText='SCAN ANY BARCODE';
}

function calculateETA(status){
  const now=new Date();
  let eta=new Date(now);
  switch(status){
    case'Data Received':eta.setDate(now.getDate()+7);break;
    case'Picked Up':eta.setDate(now.getDate()-1);break;
    case'Depart Post Office':eta.setDate(now.getDate()-2);break;
    case'Arrival Scan':eta.setHours(now.getHours()-12);break;
    case'Local Scan':eta.setHours(now.getHours()-36);break;
    case'Out For Delivery':eta.setDate(now.getDate()-2);break;
    case'Delivered':eta=now;break;
    default:eta.setDate(now.getDate()+7);
  }
  return eta;
}

function formatDate(date){
  return date.toLocaleString('en-US',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:true});
}

async function submitToXano(status){
  if(isSubmitting) return;
  if(currentScans.length===0){ alert('No scans'); return; }
  
  isSubmitting = true;
  const btn = event?.target;
  let originalText = '';
  if(btn) { originalText = btn.innerText; btn.innerText = 'SENDING...'; btn.style.opacity = '0.7'; btn.style.pointerEvents = 'none'; }
  
  if(!currentLocation){
    try{
      const position = await new Promise((resolve,reject)=>{
        navigator.geolocation.getCurrentPosition(resolve,reject, {enableHighAccuracy:true, timeout:10000});
      });
      currentLocation = { lat: position.coords.latitude, lng: position.coords.longitude, accuracy: position.coords.accuracy, timestamp: new Date().toISOString() };
      const locationData = await getCityStateFromCoords(position.coords.latitude, position.coords.longitude);
      currentLocation.address = locationData;
    } catch(error){ console.warn('GPS failed on submit'); }
  }

  const now = new Date();
  let successCount = 0;
  let errorMessages = [];
  
  for(let i = 0; i < currentScans.length; i++) {
    const scan = currentScans[i];
    const eta = calculateETA(status);
    
    let locationString = 'Warehouse';
    if(currentLocation?.address) {
      locationString = `${currentLocation.address.city}, ${currentLocation.address.state} ${currentLocation.address.zip}`;
    } else if(currentLocation) {
      locationString = `${currentLocation.lat.toFixed(4)}, ${currentLocation.lng.toFixed(4)}`;
    }
    
    const xanoRecord = {
      label_id: scan.code,
      barcode_type: scan.type,
      time: now.toLocaleTimeString(),
      date: now.toLocaleDateString(),
      status: status,
      location: locationString,
      eta: formatDate(eta),
      timestamp: now.toISOString(),
      scan_number: scan.number
    };
    
    console.log(`üì§ Sending scan ${i+1} to Xano:`, xanoRecord);
    try{
      const resp = await fetch(XANO_URL, {
        method: 'POST',
        mode: 'cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(xanoRecord)
      });
      if(resp.ok){ successCount++; } else { errorMessages.push(`Scan ${i+1}: ${await resp.text()}`); }
    } catch(e) { errorMessages.push(`Scan ${i+1}: ${e.message}`); }
  }
  
  if(btn) { btn.innerText = originalText; btn.style.opacity = '1'; btn.style.pointerEvents = 'auto'; }
  
  if(successCount > 0){
    showSuccess(status, currentScans.length, successCount);
  } else {
    alert('Xano send failed. Errors:\n' + errorMessages.join('\n'));
    // fallback: still show success for demo
    showSuccess(status, currentScans.length, currentScans.length);
  }
  
  setTimeout(() => { isSubmitting = false; }, 3000);
}

function showSuccess(status, totalScans, sentCount){
  const popup=document.getElementById('successPopup');
  document.getElementById('popupStatus').innerText='Status: '+status;
  document.getElementById('popupScanCount').innerHTML=`
    ${totalScans} barcode(s) recorded<br>
    ${sentCount} sent to database<br>
    <div class="eta-info">üìç Location: ${currentLocation?.address?.city || 'Unknown'}, ${currentLocation?.address?.state || ''}</div>
  `;
  
  popup.style.display='flex';
  setTimeout(()=>{
    popup.style.display='none';
    clearScans();
    goBackToScan();
    isSubmitting = false;
  },4000);
}

// Keypad functions - manual entry
function showNumeric(){
  document.getElementById('numericPad').style.display='grid';
  document.getElementById('qwertyPad').style.display='none';
  document.getElementById('symbolPad').style.display='none';
  document.getElementById('tabNumeric').classList.add('active');
  document.getElementById('tabQwerty').classList.remove('active');
  document.getElementById('tabSymbol').classList.remove('active');
}

function showQwerty(){
  document.getElementById('numericPad').style.display='none';
  document.getElementById('qwertyPad').style.display='block';
  document.getElementById('symbolPad').style.display='none';
  document.getElementById('tabQwerty').classList.add('active');
  document.getElementById('tabNumeric').classList.remove('active');
  document.getElementById('tabSymbol').classList.remove('active');
}

function showSymbol(){
  document.getElementById('numericPad').style.display='none';
  document.getElementById('qwertyPad').style.display='none';
  document.getElementById('symbolPad').style.display='block';
  document.getElementById('tabSymbol').classList.add('active');
  document.getElementById('tabQwerty').classList.remove('active');
  document.getElementById('tabNumeric').classList.remove('active');
}

function typeChar(c){
  const box = document.getElementById('labelBox');
  let manualDiv = document.getElementById('manualInputDiv');
  
  if (!manualDiv) {
    manualDiv = document.createElement('div');
    manualDiv.id = 'manualInputDiv';
    manualDiv.innerHTML = '<span id="manualIndicator">UPC</span> <span id="manualText"></span>';
    box.appendChild(manualDiv);
  }
  
  manualInput += c;
  document.getElementById('manualText').innerText = manualInput;
  box.scrollTop = box.scrollHeight;
}

function backspace(){
  if (manualInput.length > 0) {
    manualInput = manualInput.slice(0, -1);
    const manualText = document.getElementById('manualText');
    if (manualText) {
      manualText.innerText = manualInput;
      if (manualInput === '') {
        const manualDiv = document.getElementById('manualInputDiv');
        if (manualDiv) manualDiv.remove();
      }
    }
  }
}

function addManualAsScan() {
  if (manualInput.trim() !== '') {
    scanCount++;
    currentScans.push({
      number: scanCount,
      code: manualInput.trim(),
      type: 'MANUAL-ENTRY',
      timestamp: new Date().toISOString(),
      location: currentLocation
    });
    
    const box = document.getElementById('labelBox');
    const span = document.createElement('span');
    const locationText = currentLocation?.address ? 
      ` üìç ${currentLocation.address.city}, ${currentLocation.address.state}` : 
      (currentLocation ? ' üìç' : '');
    
    span.className = 'scan-entry';
    span.innerHTML = '‚úèÔ∏è MANUAL #' + scanCount + ': ' + manualInput.trim() + locationText + '<span id="barcodeType"> [MANUAL]</span>';
    box.appendChild(span);
    
    manualInput = '';
    const manualDiv = document.getElementById('manualInputDiv');
    if (manualDiv) manualDiv.remove();
    box.scrollTop = box.scrollHeight;
  }
}

document.addEventListener('DOMContentLoaded', function() {
  alert('üìç Warehouse mode: GPS for location stamps.\nAllow location for accurate records.');
  initGPS();
  updateTime();
  showNumeric();
  
  document.getElementById('scanButton').addEventListener('click', startScan);
  document.getElementById('clearBtn').addEventListener('click', clearScans);
  
  // ENTER = add manual then go to status
  document.getElementById('statusBtn').addEventListener('click', function() {
    addManualAsScan();
    goToStatus();
  });
  
  // Back buttons
  document.querySelectorAll('.statusBtn.back').forEach(btn => {
    btn.addEventListener('click', goBackToScan);
  });
  
  // Status buttons (remove inline onclicks)
  document.querySelectorAll('.statusBtn[data-status]').forEach(btn => {
    btn.removeAttribute('onclick');
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const status = this.getAttribute('data-status');
      submitToXano(status);
    });
  });
  
  console.log('‚úÖ Universal Barcode Scanner ready ‚Äî 1D/2D support');
});

window.addEventListener('beforeunload',()=>{
  if(gpsWatchId){navigator.geolocation.clearWatch(gpsWatchId);}
  stopCamera();
});

document.addEventListener('visibilitychange',()=>{
  if(document.hidden&&scanning){stopCamera();}
});

// Expose global functions for inline onclick (keypad)
window.startScan = startScan;
window.clearScans = clearScans;
window.goToStatus = goToStatus;
window.goBackToScan = goBackToScan;
window.showNumeric = showNumeric;
window.showQwerty = showQwerty;
window.showSymbol = showSymbol;
window.typeChar = typeChar;
window.backspace = backspace;
window.submitToXano = submitToXano;
window.addManualAsScan = addManualAsScan;
})();
</script>
</head>
<body>
<div id="phone">
  <div id="header">
    <span id="leftText">SCAN ANY BARCODE</span>
    <span id="rightArea">
      GPS: <span id="gpsIndicator">üõ∞Ô∏è</span>
      <span>üì∂</span>
      <span id="timeDisplay"></span>
    </span>
  </div>
  
  <div id="scanButton">
    <div class="scan-button">
      <div class="icon"></div>
      <div>SCAN 1D / 2D CODE</div>
    </div>
  </div>
  
  <div id="scanFrame">
    <video id="preview" autoplay playsinline></video>
    <!-- Static yellow corner brackets (mini rectangles) replace laser -->
    <div class="corner-bracket corner-tl"></div>
    <div class="corner-bracket corner-tr"></div>
    <div class="corner-bracket corner-bl"></div>
    <div class="corner-bracket corner-br"></div>
  </div>
  
  <div id="labelBlock">
    <div id="labelTitle"># SCANNED / MANUAL CODES</div>
    <div id="labelBox"></div>
    
    <div id="labelButtons">
      <span id="clearBtn">CLEAR</span>
      <span id="divider">|</span>
      <span id="statusBtn">ENTER</span>
    </div>
    
    <div id="navBar">
      <button>‚óÑ</button>
      <span id="timeDisplay2"></span>
      <button>‚ñ∫</button>
    </div>
    
    <div id="keypadWrapper">
      <div id="keyTabs">
        <button id="tabQwerty" onclick="showQwerty()">ABC</button>
        <button id="tabNumeric" onclick="showNumeric()" class="active">123</button>
        <button id="tabSymbol" onclick="showSymbol()">SYM</button>
      </div>
      
      <div id="numericPad">
        <button onclick="typeChar('1')">1</button><button onclick="typeChar('2')">2</button><button onclick="typeChar('3')">3</button>
        <button onclick="typeChar('4')">4</button><button onclick="typeChar('5')">5</button><button onclick="typeChar('6')">6</button>
        <button onclick="typeChar('7')">7</button><button onclick="typeChar('8')">8</button><button onclick="typeChar('9')">9</button>
        <button onclick="typeChar('.')">.</button><button onclick="typeChar('0')">0</button>
        <button class="backspace" onclick="backspace()">‚å´</button>
      </div>
      
      <div id="qwertyPad">
        <div class="row">
          <button onclick="typeChar('q')">q</button><button onclick="typeChar('w')">w</button><button onclick="typeChar('e')">e</button>
          <button onclick="typeChar('r')">r</button><button onclick="typeChar('t')">t</button><button onclick="typeChar('y')">y</button>
          <button onclick="typeChar('u')">u</button><button onclick="typeChar('i')">i</button><button onclick="typeChar('o')">o</button>
          <button onclick="typeChar('p')">p</button>
        </div>
        <div class="row">
          <button onclick="typeChar('a')">a</button><button onclick="typeChar('s')">s</button><button onclick="typeChar('d')">d</button>
          <button onclick="typeChar('f')">f</button><button onclick="typeChar('g')">g</button><button onclick="typeChar('h')">h</button>
          <button onclick="typeChar('j')">j</button><button onclick="typeChar('k')">k</button><button onclick="typeChar('l')">l</button>
        </div>
        <div class="row">
          <button class="special" onclick="typeChar('z')">z</button><button class="special" onclick="typeChar('x')">x</button>
          <button class="special" onclick="typeChar('c')">c</button><button class="special" onclick="typeChar('v')">v</button>
          <button class="special" onclick="typeChar('b')">b</button><button class="special" onclick="typeChar('n')">n</button>
          <button class="special" onclick="typeChar('m')">m</button><button class="special" onclick="backspace()">‚å´</button>
        </div>
        <div class="row">
          <button class="special" onclick="showNumeric()">123</button>
          <button class="space" onclick="typeChar(' ')">space</button>
          <button class="special" onclick="typeChar('.')">.</button>
        </div>
      </div>
      
      <div id="symbolPad">
        <div class="row">
          <button onclick="typeChar('@')">@</button><button onclick="typeChar('#')">#</button><button onclick="typeChar('$')">$</button>
          <button onclick="typeChar('%')">%</button><button onclick="typeChar('&')">&</button><button onclick="typeChar('*')">*</button>
          <button onclick="typeChar('(')">(</button><button onclick="typeChar(')')">)</button>
        </div>
        <div class="row">
          <button onclick="typeChar('!')">!</button><button onclick="typeChar('?')">?</button><button onclick="typeChar('/')">/</button>
          <button onclick="typeChar(':')">:</button><button onclick="typeChar(';')">;</button><button onclick="typeChar('"')">"</button>
          <button onclick="typeChar("'")">'</button><button onclick="typeChar(',')">,</button>
        </div>
        <div class="row">
          <button onclick="typeChar('-')">-</button><button onclick="typeChar('+')">+</button><button onclick="typeChar('=')">=</button>
          <button onclick="typeChar('<')">&lt;</button><button onclick="typeChar('>')">&gt;</button>
          <button onclick="typeChar('[')">[</button><button onclick="typeChar(']')">]</button>
          <button class="special" onclick="backspace()">‚å´</button>
        </div>
        <div class="row">
          <button class="special" onclick="showQwerty()">ABC</button>
          <button class="space" onclick="typeChar(' ')">space</button>
          <button class="special" onclick="typeChar('.')">.</button>
        </div>
      </div>
    </div>
  </div>
  
  <div id="statusScreen">
    <div class="statusBtn" data-status="Data Received">Data Received (+7 days)</div>
    <div class="statusBtn" data-status="Picked Up">Picked Up (-1 day)</div>
    <div class="statusBtn" data-status="Depart Post Office">Depart Post Office (-2 days)</div>
    <div class="statusBtn" data-status="Arrival Scan">Arrival Scan (-0.5 days)</div>
    <div class="statusBtn" data-status="Local Scan">Local Scan (-1.5 days)</div>
    <div class="statusBtn" data-status="Out For Delivery">Out For Delivery (-2 days)</div>
    <div class="statusBtn" data-status="Delivered">Delivered (0 days)</div>
    <div class="statusBtn back">BACK TO SCANNER</div>
  </div>
  
  <div id="successPopup">
    <div class="popup-content">
      <div class="checkmark">‚úì</div>
      <div class="popup-message">Barcode Recorded!</div>
      <div class="popup-submessage" id="popupStatus"></div>
      <div class="popup-submessage" id="popupScanCount"></div>
    </div>
  </div>
</div>
</body>
</html>
