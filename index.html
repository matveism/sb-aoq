<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!-- FIXED VIEWPORT FOR ALCATEL 7046T (5 INCH, ANDROID 5.0.2) -->
<meta name="viewport" content="width=360, initial-scale=1, maximum-scale=1, user-scalable=no, target-densitydpi=device-dpi">
<title>U¬∑BARCODE ¬∑ FIXED</title>
<style>
/* RESET & HARDWARE ACCELERATION */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none;}
input,textarea,button,select{outline:none;border:none;background:none;}

body{
    background:#000;
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    font-family:system-ui,'Segoe UI',Roboto,sans-serif;
    font-weight:bold;
    margin:0;
    padding:0;
}

/* EXACT DEVICE FRAME ‚Äì NO SCROLLING ON 5" 640x360 (ALCATEL 7046T) */
#phone{
    width:360px;
    height:640px;
    background:#2b4b70;
    color:#fff;
    display:flex;
    flex-direction:column;
    box-shadow:0 10px 25px #000;
    overflow:hidden;            /* no outer scroll */
    position:relative;
    touch-action:pan-y;         /* prevent pull-to-refresh interference */
}

/* HEADER 38px */
#header{
    height:38px;
    background:#2e5a88;
    border-bottom:2px solid #1f3f5c;
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:0 8px 0 12px;
    font-size:16px;
    flex-shrink:0;
}
#leftText{color:#fff;white-space:nowrap;}
#rightArea{display:flex;align-items:center;gap:6px;}
#gpsIndicator{font-size:18px;}
#flashIndicator{font-size:20px;padding:2px 6px;background:#0004;border-radius:4px;cursor:pointer;}
#timeDisplay{color:#ffcc00;font-size:13px;}

/* SCAN BUTTON ‚Äì fixed size, no movement */
#scanBtn{
    width:calc(100% - 24px);
    height:48px;
    margin:8px auto;
    background:#2b6e2f;
    border:2px solid #1e5a22;
    color:#fff;
    font-size:22px;
    font-weight:bold;
    border-radius:6px;
    box-shadow:0 4px 0 #145018;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    flex-shrink:0;
    -webkit-touch-callout:none;
    -webkit-user-select:none;
    user-select:none;
    touch-action:manipulation;   /* force native click handling */
}
/* active state but no layout shift */
#scanBtn:active{
    background:#2b8c3a;
    transform:translateY(2px);
    box-shadow:0 2px 0 #145018;
}

/* SCAN FRAME */
#scanFrame{
    width:100%;
    height:200px;
    background:#000;
    border:2px solid #fc0;
    position:relative;
    display:none;
    flex-shrink:0;
    overflow:hidden;
}
#preview{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
}
.corner{
    position:absolute;
    width:28px;
    height:28px;
    border:4px solid #fc0;
    pointer-events:none;
}
.tl{top:0;left:0;border-right:none;border-bottom:none;}
.tr{top:0;right:0;border-left:none;border-bottom:none;}
.bl{bottom:0;left:0;border-right:none;border-top:none;}
.br{bottom:0;right:0;border-left:none;border-top:none;}
#torchBtn{
    position:absolute;
    bottom:8px;
    right:8px;
    background:#000c;
    color:#fc0;
    padding:6px 12px;
    border-radius:20px;
    font-size:13px;
    font-weight:bold;
    cursor:pointer;
    border:1px solid #fc0;
    z-index:20;
}

/* LABEL BLOCK */
#labelBlock{
    display:flex;
    flex-direction:column;
    flex:1;
    min-height:0;
    width:100%;
}
#labelTitle{
    height:32px;
    background:#2b4b70;
    border:1px solid #1f3f5c;
    display:flex;
    align-items:center;
    padding-left:12px;
    margin:0 12px;
    font-size:14px;
    flex-shrink:0;
}
#labelBox{
    width:calc(100% - 24px);
    margin:0 auto;
    border:3px solid #1f3f5c;
    background:#A6BEEF;
    padding:6px;
    font-size:14px;
    color:#000;
    overflow-y:auto;
    min-height:70px;
    max-height:120px;
    font-family:monospace;
    -webkit-overflow-scrolling:touch; /* smooth scroll but not needed */
}
#labelBox span{
    display:block;
    background:#c0d4f5;
    padding:4px;
    margin:4px 0;
    border-bottom:2px solid #2b4b70;
    font-weight:bold;
    word-break:break-all;
}
#labelButtons{
    height:42px;
    background:#7496C4;
    display:flex;
    align-items:center;
    justify-content:space-between;
    border:2px solid #3a5f8a;
    margin:8px 12px 0;
    padding:0 16px;
    font-size:18px;
    color:#fff;
    flex-shrink:0;
}
#labelButtons span{
    cursor:pointer;
    padding:4px 12px;
    touch-action:manipulation;
}
#labelButtons span:active{
    background:#27ae60;
    border-radius:4px;
}

/* NAV BAR */
#navBar{
    height:36px;
    background:#2b4b70;
    display:flex;
    align-items:center;
    justify-content:space-between;
    border:1px solid #1f3f5c;
    margin:6px 12px 0;
    padding:0 8px;
    font-size:14px;
    flex-shrink:0;
}
#navBar button{
    background:none;
    border:none;
    color:#fff;
    font-size:22px;
    cursor:pointer;
    padding:0 6px;
    touch-action:manipulation;
}

/* KEYPAD WRAPPER ‚Äì ALWAYS VISIBLE */
#keypadWrapper{
    background:#1f3f5c;
    border-top:3px solid #fc0;
    margin-top:auto;           /* push to bottom */
    padding-bottom:6px;
    flex-shrink:0;
}
#keyTabs{
    display:flex;
    padding:6px 12px;
    gap:4px;
}
#keyTabs button{
    flex:1;
    background:#3a5f8a;
    border:2px solid #1f3f5c;
    border-radius:30px;
    color:#fff;
    font-weight:bold;
    padding:5px 0;
    cursor:pointer;
    touch-action:manipulation;
    font-size:16px;
}
#keyTabs button.active{
    background:#4CAF50;
    border-color:#145018;
}
#numericPad{
    display:flex;
    flex-wrap:wrap;
    padding:4px 12px 8px;
    gap:4px;
}
#numericPad button{
    width:calc(33.333% - 4px);
    background:#3a5f8a;
    border:1px solid #1f3f5c;
    border-radius:6px;
    color:#fff;
    font-size:26px;
    font-weight:bold;
    height:48px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    box-shadow:0 3px 0 #1f3f5c;
    margin:0;
    touch-action:manipulation;
}
#numericPad button:active{
    background:#4CAF50;
    transform:translateY(2px);
}
.backspace{
    background:#2b4b70!important;
    font-size:22px;
}
#qwertyPad,#symbolPad{
    display:none;
    padding:0 8px 8px;
}
.row{
    display:flex;
    margin-bottom:4px;
    justify-content:center;
}
.row button{
    flex:1;
    max-width:34px;
    background:#3a5f8a;
    border:1px solid #1f3f5c;
    border-radius:6px;
    color:#fff;
    font-size:16px;
    height:40px;
    margin:0 1px;
    cursor:pointer;
    box-shadow:0 2px 0 #1f3f5c;
    touch-action:manipulation;
}
.row button:active{
    background:#4CAF50;
    transform:translateY(2px);
}
.special{
    max-width:50px!important;
    background:#2b4b70!important;
}
.space{
    flex:3!important;
    max-width:180px!important;
}

/* STATUS OVERLAY */
#statusScreen{
    display:none;
    position:absolute;
    top:38px;
    left:0;
    right:0;
    bottom:0;
    background:#1c3046;
    z-index:100;
    padding:20px 15px;
    overflow-y:auto;
    flex-direction:column;
}
.statBtn{
    background:#2b4b70;
    border:2px solid #fc0;
    color:#fff;
    font-size:18px;
    font-weight:bold;
    padding:14px;
    margin-bottom:10px;
    text-align:center;
    border-radius:8px;
    cursor:pointer;
    touch-action:manipulation;
}
.statBtn:active{
    background:#4CAF50;
}
.backBtn{
    background:#1f3f5c;
    border-color:#f1c40f;
    margin-top:20px;
}

/* SUCCESS POPUP */
#successPopup{
    display:none;
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:#000b;
    z-index:1000;
    align-items:center;
    justify-content:center;
}
.popup{
    background:#2b4b70;
    border:3px solid #27ae60;
    border-radius:20px;
    padding:25px 15px;
    width:260px;
    text-align:center;
}
.check{
    width:60px;
    height:60px;
    background:#27ae60;
    border-radius:50%;
    font-size:42px;
    line-height:60px;
    margin:0 auto 10px;
    color:#fff;
}
#popupStatus{color:#ffcc00;font-size:15px;margin:5px 0;}
</style>
<!-- ZXING LIBRARY (legacy for android 5) -->
<script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
</head>
<body>
<div id="phone">
  <div id="header">
    <span id="leftText">SCAN QR</span>
    <span id="rightArea">
      <span id="flashIndicator" onclick="toggleFlash()">üî¶</span>
      <span id="gpsIndicator">üåê</span>
      <span id="timeDisplay"></span>
    </span>
  </div>
  <!-- SCAN BUTTON: ensure event is direct -->
  <div id="scanBtn"><span style="width:16px;height:12px;background:repeating-linear-gradient(90deg,#000,#000 2px,#fff 2px,#fff 4px);margin-right:8px"></span>SCAN 1D/2D</div>
  <div id="scanFrame">
    <video id="preview" autoplay playsinline></video>
    <div id="torchBtn" onclick="toggleFlash()">üî¶ OFF</div>
    <div class="corner tl"></div><div class="corner tr"></div><div class="corner bl"></div><div class="corner br"></div>
  </div>
  <div id="labelBlock">
    <div id="labelTitle"># SCANNED CODES</div>
    <div id="labelBox"></div>
    <div id="labelButtons"><span id="clearBtn">CLEAR</span><span>|</span><span id="statusBtn">ENTER</span></div>
    <div id="navBar"><button onclick="alert('Prev')">‚óÑ</button><span id="timeDisplay2"></span><button onclick="alert('Next')">‚ñ∫</button></div>
    <!-- KEYPAD AREA -->
    <div id="keypadWrapper">
      <div id="keyTabs">
        <button id="tabQ" onclick="showPad('q')">ABC</button>
        <button id="tabN" onclick="showPad('n')" class="active">123</button>
        <button id="tabS" onclick="showPad('s')">SYM</button>
      </div>
      <!-- NUMERIC PAD (default) -->
      <div id="numericPad">
        <button onclick="add('1')">1</button><button onclick="add('2')">2</button><button onclick="add('3')">3</button>
        <button onclick="add('4')">4</button><button onclick="add('5')">5</button><button onclick="add('6')">6</button>
        <button onclick="add('7')">7</button><button onclick="add('8')">8</button><button onclick="add('9')">9</button>
        <button onclick="add('.')">.</button><button onclick="add('0')">0</button>
        <button class="backspace" onclick="bs()">‚å´</button>
      </div>
      <!-- QWERTY -->
      <div id="qwertyPad">
        <div class="row"><button onclick="add('q')">q</button><button onclick="add('w')">w</button><button onclick="add('e')">e</button><button onclick="add('r')">r</button><button onclick="add('t')">t</button><button onclick="add('y')">y</button><button onclick="add('u')">u</button><button onclick="add('i')">i</button><button onclick="add('o')">o</button><button onclick="add('p')">p</button></div>
        <div class="row"><button onclick="add('a')">a</button><button onclick="add('s')">s</button><button onclick="add('d')">d</button><button onclick="add('f')">f</button><button onclick="add('g')">g</button><button onclick="add('h')">h</button><button onclick="add('j')">j</button><button onclick="add('k')">k</button><button onclick="add('l')">l</button></div>
        <div class="row"><button class="special" onclick="add('z')">z</button><button class="special" onclick="add('x')">x</button><button class="special" onclick="add('c')">c</button><button class="special" onclick="add('v')">v</button><button class="special" onclick="add('b')">b</button><button class="special" onclick="add('n')">n</button><button class="special" onclick="add('m')">m</button><button class="special" onclick="bs()">‚å´</button></div>
        <div class="row"><button class="special" onclick="showPad('n')">123</button><button class="space" onclick="add(' ')">space</button><button class="special" onclick="add('.')">.</button></div>
      </div>
      <!-- SYMBOL -->
      <div id="symbolPad">
        <div class="row"><button onclick="add('@')">@</button><button onclick="add('#')">#</button><button onclick="add('$')">$</button><button onclick="add('%')">%</button><button onclick="add('&')">&</button><button onclick="add('*')">*</button><button onclick="add('(')">(</button><button onclick="add(')')">)</button></div>
        <div class="row"><button onclick="add('!')">!</button><button onclick="add('?')">?</button><button onclick="add('/')">/</button><button onclick="add(':')">:</button><button onclick="add(';')">;</button><button onclick="add('"')">"</button><button onclick="add("'")">'</button><button onclick="add(',')">,</button></div>
        <div class="row"><button onclick="add('-')">-</button><button onclick="add('+')">+</button><button onclick="add('=')">=</button><button onclick="add('<')">&lt;</button><button onclick="add('>')">&gt;</button><button onclick="add('[')">[</button><button onclick="add(']')">]</button><button class="special" onclick="bs()">‚å´</button></div>
        <div class="row"><button class="special" onclick="showPad('q')">ABC</button><button class="space" onclick="add(' ')">space</button><button class="special" onclick="add('.')">.</button></div>
      </div>
    </div>
  </div>
  <!-- STATUS SCREEN -->
  <div id="statusScreen">
    <div class="statBtn" data-st="Data Received">Data Received (+7)</div>
    <div class="statBtn" data-st="Picked Up">Picked Up (-1)</div>
    <div class="statBtn" data-st="Depart Post Office">Depart PO (-2)</div>
    <div class="statBtn" data-st="Arrival Scan">Arrival (-0.5)</div>
    <div class="statBtn" data-st="Local Scan">Local (-1.5)</div>
    <div class="statBtn" data-st="Out For Delivery">Out (-2)</div>
    <div class="statBtn" data-st="Delivered">Delivered (0)</div>
    <div class="statBtn backBtn" id="backToScan">BACK</div>
  </div>
  <div id="successPopup"><div class="popup"><div class="check">‚úì</div><div class="popup-message">Success!</div><div id="popupStatus"></div><div id="popupScanCount"></div></div></div>
</div>

<script>
(function(){
    // ========== CONFIG ==========
    const XANO_URL='https://x8ki-letl-twmt.n7.xano.io/api:WGx5FQAG/qr_scans'; 

    let stream=null, scanning=false, scanCount=0, scans=[], gps=null, watchId=null;
    let audioCtx=null;
    const video=document.getElementById('preview');
    const frame=document.getElementById('scanFrame');
    const box=document.getElementById('labelBox');
    const leftTxt=document.getElementById('leftText');
    const gpsInd=document.getElementById('gpsIndicator');
    const torch=document.getElementById('torchBtn');
    const flash=document.getElementById('flashIndicator');

    // ----- AUDIO FEEDBACK (android 5 compatible) -----
    function playBeep(){
        try{
            if(!audioCtx){
                audioCtx=new (window.AudioContext || window.webkitAudioContext)();
            }
            if(audioCtx.state==='suspended'){
                audioCtx.resume().then(()=>beep(audioCtx));
            }else{
                beep(audioCtx);
            }
        }catch(e){}
    }
    function beep(ctx){
        const o=ctx.createOscillator();
        const g=ctx.createGain();
        o.type='sine';
        o.frequency.value=880;
        g.gain.setValueAtTime(0.3,ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.15);
        o.connect(g).connect(ctx.destination);
        o.start();
        o.stop(ctx.currentTime+0.15);
    }

    // ----- GPS -----
    function updateGPS(has){
        gpsInd.innerHTML=has?'üõ∞Ô∏è':'üåê';
        gpsInd.style.color=has?'#4CAF50':'#ff4444';
    }
    function initGPS(){
        if(!navigator.geolocation){updateGPS(0); return;}
        navigator.geolocation.getCurrentPosition(
            p=>{gps={lat:p.coords.latitude,lng:p.coords.longitude,acc:p.coords.accuracy}; updateGPS(1);},
            ()=>updateGPS(0),
            {enableHighAccuracy:true,timeout:8000}
        );
        watchId=navigator.geolocation.watchPosition(
            p=>{gps={lat:p.coords.latitude,lng:p.coords.longitude,acc:p.coords.accuracy}; updateGPS(1);},
            ()=>updateGPS(0),
            {enableHighAccuracy:true,maximumAge:0}
        );
    }

    // ----- CAMERA CONTROL -----
    function stopCam(){
        if(stream){
            stream.getTracks().forEach(t=>t.stop());
            stream=null;
        }
        scanning=false;
    }
    async function startScan(){
        if(scanning){
            stopCam();
            frame.style.display='none';
            return;
        }
        scanning=true;
        frame.style.display='block';
        torch.innerText='üî¶ OFF';
        torch.style.background='#000c';
        torch.style.color='#fc0';
        try{
            stream = await navigator.mediaDevices.getUserMedia({
                video:{facingMode:'environment', width:640, height:480}
            });
            video.srcObject = stream;
            await video.play();
            const codeReader = new ZXing.BrowserMultiFormatReader();
            codeReader.decodeFromVideoElement(video, (result, err) => {
                if(result){
                    onDecode(result.getText(), result.getBarcodeFormat());
                    codeReader.reset();
                    stopCam();
                    frame.style.display='none';
                }
            });
        }catch(e){
            console.log(e);
            alert('Camera failed');
            stopCam();
            frame.style.display='none';
            scanning=false;
        }
    }

    // ----- DECODE HANDLER -----
    function onDecode(code, type){
        playBeep();
        scanCount++;
        scans.push({num:scanCount, code, type: type||'QR_CODE', time:new Date().toISOString(), loc:gps});
        const span=document.createElement('span');
        span.innerHTML = scanCount+' '+code+(gps?' üìç':'')+' ['+(type||'QR')+']';
        box.appendChild(span);
        box.scrollTop = box.scrollHeight;
    }

    // ----- CLEAR, STATUS NAVIGATION -----
    function clearAll(){
        scanCount=0;
        scans=[];
        box.innerHTML='';
    }
    function showStatus(){
        if(!scans.length){alert('Scan first'); return;}
        document.getElementById('labelBlock').style.display='none';
        document.getElementById('scanBtn').style.display='none';
        leftTxt.innerText='SELECT STATUS';
        document.getElementById('statusScreen').style.display='flex';
    }
    function goBack(){
        document.getElementById('statusScreen').style.display='none';
        document.getElementById('labelBlock').style.display='flex';
        document.getElementById('scanBtn').style.display='flex';
        leftTxt.innerText='SCAN QR';
    }
    function etaCalc(st){
        const d=new Date();
        if(st.includes('Received')) d.setDate(d.getDate()+7);
        else if(st.includes('Picked')) d.setDate(d.getDate()-1);
        else if(st.includes('Depart')) d.setDate(d.getDate()-2);
        else if(st.includes('Arrival')) d.setHours(d.getHours()-12);
        else if(st.includes('Local')) d.setHours(d.getHours()-36);
        else if(st.includes('Out')) d.setDate(d.getDate()-2);
        return d.toLocaleString('en-US',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
    }
    async function submitStatus(status){
        if(!scans.length) return;
        if(!gps){
            try{
                gps = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{timeout:5000}));
                updateGPS(!!gps);
            }catch(e){}
        }
        const packs = scans.map(s=>({
            LABEL_ID:s.code,
            BARCODE_TYPE:s.type,
            TIME:new Date().toLocaleTimeString(),
            DATE:new Date().toLocaleDateString(),
            STATUS:status,
            LOCATION:gps?`${gps.lat},${gps.lng}`:'unavailable',
            ETA:etaCalc(status),
            TIMESTAMP:new Date().toISOString()
        }));
        const body={scans:packs, status, timestamp:new Date().toISOString(), location:gps, batch_id:Date.now()+''};
        try{
            let r=await fetch(XANO_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
            if(r.ok){
                popup(status,packs);
            }else{
                alert('Xano error '+r.status);
            }
        }catch(e){alert('Network fail');}
    }
    function popup(st,packs){
        let html=packs.map(p=>`${p.LABEL_ID.slice(0,8)}‚Ä¶ ETA:${p.ETA}`).join('<br>');
        document.getElementById('popupStatus').innerText='Status: '+st;
        document.getElementById('popupScanCount').innerHTML=scanCount+' QR(s)<br>'+html;
        document.getElementById('successPopup').style.display='flex';
        setTimeout(()=>{
            document.getElementById('successPopup').style.display='none';
            clearAll();
            goBack();
        },4000);
    }

    // ========== KEYPAD FUNCTIONS (FIXED FOR TOUCH) ==========
    window.add = function(c){
        const s=document.createElement('span');
        s.innerText = c;
        box.appendChild(s);
        box.scrollTop = box.scrollHeight;
    };
    window.bs = function(){
        if(box.lastChild) box.removeChild(box.lastChild);
    };
    window.showPad = function(mode){
        document.getElementById('numericPad').style.display='none';
        document.getElementById('qwertyPad').style.display='none';
        document.getElementById('symbolPad').style.display='none';
        document.getElementById('tabN').classList.remove('active');
        document.getElementById('tabQ').classList.remove('active');
        document.getElementById('tabS').classList.remove('active');
        if(mode==='n'){
            document.getElementById('numericPad').style.display='flex';
            document.getElementById('tabN').classList.add('active');
        } else if(mode==='q'){
            document.getElementById('qwertyPad').style.display='block';
            document.getElementById('tabQ').classList.add('active');
        } else {
            document.getElementById('symbolPad').style.display='block';
            document.getElementById('tabS').classList.add('active');
        }
    };

    // FLASH (torch) with error prevention
    window.toggleFlash = function(){
        if(!stream) return;
        const track = stream.getVideoTracks()[0];
        if(!track || !track.applyConstraints) return;
        const newState = torch.innerText.includes('OFF') ? 'ON' : 'OFF';
        torch.innerText = newState==='ON' ? 'üî¶ ON' : 'üî¶ OFF';
        flash.style.background = newState==='ON' ? '#4CAF50' : '#0004';
        try{
            track.applyConstraints({advanced:[{torch: newState==='ON'}]});
        }catch(e){}
    };

    // CLOCK
    function updateClock(){
        const d=new Date();
        const m=(d.getMonth()+1).toString().padStart(2,'0');
        const day=d.getDate().toString().padStart(2,'0');
        let h=d.getHours()%12; if(h===0) h=12;
        const min=d.getMinutes().toString().padStart(2,'0');
        const ap=d.getHours()>=12?'PM':'AM';
        document.getElementById('timeDisplay').innerText=m+'/'+day+' '+h+':'+min+' '+ap;
        document.getElementById('timeDisplay2').innerText=m+'/'+day+' '+h+':'+min+' '+ap;
    }
    setInterval(updateClock,1000);

    // ========== INIT ==========
    window.onload=function(){
        initGPS();
        updateClock();
        showPad('n');   // numeric default

        // DIRECT EVENT LISTENERS (no complex delegation)
        document.getElementById('scanBtn').addEventListener('click', startScan);
        document.getElementById('clearBtn').addEventListener('click', clearAll);
        document.getElementById('statusBtn').addEventListener('click', showStatus);
        document.getElementById('backToScan').addEventListener('click', goBack);
        document.querySelectorAll('.statBtn[data-st]').forEach(b=>{
            b.addEventListener('click', ()=>submitStatus(b.dataset.st));
        });

        if(!navigator.mediaDevices) alert('No camera support');
    };

    window.addEventListener('beforeunload',()=>{
        if(watchId) navigator.geolocation.clearWatch(watchId);
        stopCam();
    });
})();
</script>
</body>
</html>
