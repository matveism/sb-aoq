<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>U-BARCODE SCANNER</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}
html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: #000;
  font-family: Arial, sans-serif;
}
#app {
  width: 100%;
  height: 100%;
  max-width: 480px;
  margin: 0 auto;
  background: #2b4b70;
  display: -webkit-box;
  display: flex;
  -webkit-box-orient: vertical;
  flex-direction: column;
  position: relative;
}
#header {
  background: #1e3a5f;
  color: #fff;
  padding: 12px;
  font-size: 18px;
  font-weight: bold;
  display: -webkit-box;
  display: flex;
  -webkit-box-pack: justify;
  justify-content: space-between;
  -webkit-box-align: center;
  align-items: center;
  border-bottom: 2px solid #ffcc00;
}
#flashBtn {
  background: rgba(0,0,0,0.5);
  border: 2px solid #ffcc00;
  color: #ffcc00;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
}
#flashBtn.on {
  background: #4CAF50;
  color: white;
  border-color: white;
}
#scanArea {
  position: relative;
  width: 100%;
  height: 300px;
  background: #000;
  overflow: hidden;
}
#video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
#scanLine {
  position: absolute;
  top: 50%;
  left: 10%;
  right: 10%;
  height: 2px;
  background: #00ff00;
  box-shadow: 0 0 10px #00ff00;
  animation: scan 2s linear infinite;
}
@keyframes scan {
  0%, 100% { top: 20%; }
  50% { top: 80%; }
}
.corner {
  position: absolute;
  width: 40px;
  height: 40px;
  border: 3px solid #ffcc00;
}
.corner.tl { top: 20px; left: 20px; border-right: none; border-bottom: none; }
.corner.tr { top: 20px; right: 20px; border-left: none; border-bottom: none; }
.corner.bl { bottom: 20px; left: 20px; border-right: none; border-top: none; }
.corner.br { bottom: 20px; right: 20px; border-left: none; border-top: none; }
#controls {
  padding: 15px;
  background: #1e3a5f;
}
#scanBtn {
  width: 100%;
  padding: 15px;
  background: #27ae60;
  color: white;
  font-size: 20px;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  margin-bottom: 10px;
}
#scanBtn:active {
  background: #229954;
}
#scanBtn.scanning {
  background: #e74c3c;
}
#results {
  -webkit-box-flex: 1;
  flex: 1;
  overflow-y: auto;
  padding: 15px;
  background: #34495e;
}
.scan-item {
  background: #2c3e50;
  color: white;
  padding: 12px;
  margin-bottom: 8px;
  border-radius: 6px;
  border-left: 4px solid #3498db;
  font-size: 14px;
  word-break: break-all;
}
.scan-item .code {
  font-weight: bold;
  color: #3498db;
  font-size: 16px;
  margin-bottom: 4px;
}
.scan-item .meta {
  color: #95a5a6;
  font-size: 12px;
}
#statusPanel {
  display: none;
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: #1e3a5f;
  z-index: 1000;
  overflow-y: auto;
  padding: 15px;
}
#statusPanel.show {
  display: block;
}
.status-btn {
  width: 100%;
  padding: 15px;
  background: #3498db;
  color: white;
  font-size: 16px;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  margin-bottom: 10px;
  cursor: pointer;
}
.status-btn:active {
  background: #2980b9;
}
.status-btn.back {
  background: #95a5a6;
}
#submitBtn {
  width: 100%;
  padding: 15px;
  background: #f39c12;
  color: white;
  font-size: 18px;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
#submitBtn:active {
  background: #e67e22;
}
#popup {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  z-index: 2000;
}
#popup.show {
  display: -webkit-box;
  display: flex;
  -webkit-box-align: center;
  align-items: center;
  -webkit-box-pack: center;
  justify-content: center;
}
.popup-box {
  background: white;
  padding: 30px;
  border-radius: 15px;
  text-align: center;
  max-width: 300px;
}
.popup-icon {
  font-size: 60px;
  margin-bottom: 15px;
}
.popup-text {
  font-size: 18px;
  font-weight: bold;
  color: #2c3e50;
  margin-bottom: 10px;
}
.popup-sub {
  font-size: 14px;
  color: #7f8c8d;
}
</style>
</head>
<body>
<div id="app">
  <div id="header">
    <span>üì¶ BARCODE SCANNER</span>
    <button id="flashBtn" onclick="toggleFlash()">üî¶ OFF</button>
  </div>
  
  <div id="scanArea">
    <video id="video" autoplay playsinline></video>
    <div id="scanLine"></div>
    <div class="corner tl"></div>
    <div class="corner tr"></div>
    <div class="corner bl"></div>
    <div class="corner br"></div>
  </div>
  
  <div id="controls">
    <button id="scanBtn" onclick="toggleScan()">START SCANNING</button>
    <button id="submitBtn" onclick="showStatus()">SUBMIT TO DATABASE</button>
  </div>
  
  <div id="results"></div>
  
  <div id="statusPanel">
    <h2 style="color: white; margin-bottom: 20px;">SELECT STATUS:</h2>
    <button class="status-btn" onclick="submitData('Data Received')">Data Received</button>
    <button class="status-btn" onclick="submitData('Picked Up')">Picked Up</button>
    <button class="status-btn" onclick="submitData('In Transit')">In Transit</button>
    <button class="status-btn" onclick="submitData('Out For Delivery')">Out For Delivery</button>
    <button class="status-btn" onclick="submitData('Delivered')">Delivered</button>
    <button class="status-btn back" onclick="hideStatus()">‚Üê BACK</button>
  </div>
  
  <div id="popup">
    <div class="popup-box">
      <div class="popup-icon">‚úÖ</div>
      <div class="popup-text" id="popupText">Success!</div>
      <div class="popup-sub" id="popupSub"></div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
<script>
(function() {
  var scanning = false;
  var stream = null;
  var reader = null;
  var scans = [];
  var flashOn = false;
  var XANO_URL = 'https://x8ki-letl-twmt.n7.xano.io/api:WGx5FQAG/qr_scans';
  
  window.toggleScan = function() {
    if (scanning) {
      stopScan();
    } else {
      startScan();
    }
  };
  
  function startScan() {
    var video = document.getElementById('video');
    var btn = document.getElementById('scanBtn');
    
    btn.textContent = 'STARTING...';
    btn.disabled = true;
    
    var constraints = {
      video: {
        facingMode: { ideal: 'environment' },
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    };
    
    // Try to get camera
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia(constraints)
        .then(function(s) {
          stream = s;
          video.srcObject = s;
          video.play();
          scanning = true;
          btn.textContent = 'STOP SCANNING';
          btn.className = 'scanning';
          btn.disabled = false;
          startDecoding();
        })
        .catch(function(err) {
          alert('Camera error: ' + err.message);
          btn.textContent = 'START SCANNING';
          btn.disabled = false;
        });
    } else if (navigator.getUserMedia) {
      navigator.getUserMedia(constraints.video, function(s) {
        stream = s;
        video.src = window.URL.createObjectURL(s);
        video.play();
        scanning = true;
        btn.textContent = 'STOP SCANNING';
        btn.className = 'scanning';
        btn.disabled = false;
        startDecoding();
      }, function(err) {
        alert('Camera error: ' + err.message);
        btn.textContent = 'START SCANNING';
        btn.disabled = false;
      });
    } else {
      alert('Camera not supported');
      btn.textContent = 'START SCANNING';
      btn.disabled = false;
    }
  }
  
  function startDecoding() {
    var video = document.getElementById('video');
    reader = new ZXing.BrowserMultiFormatReader();
    
    reader.decodeFromVideoDevice(undefined, 'video', function(result, err) {
      if (result) {
        var code = result.text;
        var format = result.format || 'UNKNOWN';
        
        // Beep
        var beep = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGe57OeyTBELUKXh7bllHAU7k9r0yXkn');
        beep.play().catch(function(){});
        
        // Add to list
        var scan = {
          code: code,
          format: format.toString(),
          time: new Date().toISOString()
        };
        scans.push(scan);
        
        // Display
        var results = document.getElementById('results');
        var item = document.createElement('div');
        item.className = 'scan-item';
        item.innerHTML = '<div class="code">' + code + '</div><div class="meta">' + format + ' ‚Ä¢ ' + new Date().toLocaleTimeString() + '</div>';
        results.insertBefore(item, results.firstChild);
        
        console.log('‚úÖ Scanned:', code);
      }
    }).catch(function(err) {
      console.error('Decode error:', err);
    });
  }
  
  function stopScan() {
    if (reader) {
      reader.reset();
      reader = null;
    }
    if (stream) {
      stream.getTracks().forEach(function(track) {
        track.stop();
      });
      stream = null;
    }
    scanning = false;
    flashOn = false;
    document.getElementById('scanBtn').textContent = 'START SCANNING';
    document.getElementById('scanBtn').className = '';
    document.getElementById('flashBtn').textContent = 'üî¶ OFF';
    document.getElementById('flashBtn').className = '';
  }
  
  window.toggleFlash = function() {
    if (!stream) {
      alert('Start scanning first!');
      return;
    }
    
    var track = stream.getVideoTracks()[0];
    if (!track) return;
    
    flashOn = !flashOn;
    
    if (track.applyConstraints) {
      track.applyConstraints({
        advanced: [{ torch: flashOn }]
      }).then(function() {
        document.getElementById('flashBtn').textContent = flashOn ? 'üî¶ ON' : 'üî¶ OFF';
        document.getElementById('flashBtn').className = flashOn ? 'on' : '';
      }).catch(function() {
        alert('Flashlight not supported');
        flashOn = false;
      });
    } else {
      alert('Flashlight not supported');
    }
  };
  
  window.showStatus = function() {
    if (scans.length === 0) {
      alert('No scans yet! Scan some barcodes first.');
      return;
    }
    document.getElementById('statusPanel').className = 'show';
  };
  
  window.hideStatus = function() {
    document.getElementById('statusPanel').className = '';
  };
  
  window.submitData = function(status) {
    if (scans.length === 0) {
      alert('No scans to submit!');
      return;
    }
    
    var sent = 0;
    var total = scans.length;
    
    function sendNext(i) {
      if (i >= scans.length) {
        // Done
        hideStatus();
        showPopup('‚úÖ Success!', sent + ' of ' + total + ' sent to XANO database');
        scans = [];
        document.getElementById('results').innerHTML = '';
        return;
      }
      
      var scan = scans[i];
      var data = {
        label_id: scan.code,
        barcode_type: scan.format,
        status: status,
        timestamp: scan.time,
        scan_number: i + 1,
        location: 'Mobile'
      };
      
      var xhr = new XMLHttpRequest();
      xhr.open('POST', XANO_URL, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      
      xhr.onload = function() {
        if (xhr.status >= 200 && xhr.status < 300) {
          sent++;
          console.log('‚úÖ Sent to XANO:', scan.code);
        } else {
          console.error('‚ùå XANO error:', xhr.status, xhr.responseText);
        }
        sendNext(i + 1);
      };
      
      xhr.onerror = function() {
        console.error('‚ùå Network error');
        sendNext(i + 1);
      };
      
      xhr.send(JSON.stringify(data));
    }
    
    sendNext(0);
  };
  
  function showPopup(title, sub) {
    document.getElementById('popupText').textContent = title;
    document.getElementById('popupSub').textContent = sub;
    document.getElementById('popup').className = 'show';
    
    setTimeout(function() {
      document.getElementById('popup').className = '';
    }, 3000);
  }
  
  // Auto-start on load
  window.onload = function() {
    console.log('üì± Barcode Scanner Ready!');
    console.log('üé• Camera:', navigator.mediaDevices ? 'Supported' : 'Not supported');
    console.log('üì° XANO URL:', XANO_URL);
  };
  
})();
</script>
</body>
</html>
