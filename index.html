<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Android 5.0 Screen</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: Roboto, Arial, sans-serif;
    }

    .device {
      width: 360px;
      height: 640px;
      background: #B0C8E2;
      color: black;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
      overflow: hidden;
      position: relative;
    }

    .header {
      background: #15569B;
      color: #D0D7DC;
      height: 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      font-size: 14px;
    }

    .scan-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      padding: 10px 8px;
      gap: 6px;
      background: #B0C8E2;
    }

    .submit-btn {
      background: #28a745;
      border: none;
      padding: 8px 16px;
      font-weight: bold;
      color: white;
      border-radius: 4px;
      font-size: 16px;
      height: 36px;
      display: flex;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      border: 1px solid #1e7e34;
    }

    .submit-btn:active {
      background: #218838;
      transform: translateY(1px);
    }

    .mini-grid {
      display: flex;
      flex-direction: row;
      gap: 2px;
      height: 28px;
      align-items: center;
      flex: 1;
    }

    .mini-cell {
      width: 33px;
      height: 25px;
      background: #E2E8D3;
      border: 1px solid #999;
      border-radius: 2px;
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      color: black;
      outline: none;
    }

    .content {
      flex: 1;
      padding: 8px;
      overflow-y: auto;
    }

    #preview {
      width: 100%;
      height: 200px;
      background: #000;
      display: none;
      object-fit: cover;
    }

    /* STATUS FIELDS */
    .status-fields {
      margin: 10px 0;
      padding: 8px;
      background: #96BEEE;
      border-radius: 4px;
      border: 2px solid #79A4D2;
    }

    .field-row {
      margin-bottom: 8px;
    }

    .field-row label {
      display: block;
      font-size: 12px;
      font-weight: bold;
      color: #15569B;
      margin-bottom: 2px;
    }

    .field-row select,
    .field-row input {
      width: 100%;
      padding: 6px;
      border: 1px solid #79A4D2;
      border-radius: 3px;
      font-size: 14px;
      background: white;
      box-sizing: border-box;
    }

    .field-row input:focus,
    .field-row select:focus {
      outline: 2px solid #FCC57A;
      border-color: #FCC57A;
    }

    .field-row input[readonly] {
      background: #e2e8d3;
      font-weight: bold;
    }

    /* RESULT BOX */
    .result-box {
      margin-top: 10px;
      border: 2px solid #79A4D2;
      border-radius: 4px;
      overflow: hidden;
      font-size: 16px;
      font-weight: bold;
    }

    .result-header,
    .result-row {
      display: grid;
      grid-template-columns: 40px 1fr;
      align-items: center;
    }

    .result-header {
      background: #79A4D2;
      color: black;
    }

    .result-row {
      background: #96BEEE;
      color: black;
    }

    .result-cell {
      padding: 6px 10px;
    }

    .result-cell-value {
      font-weight: bold;
    }

    /* POPUP */
    #popup {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 180px;
      margin-left: -90px;
      margin-top: -80px;
      background: #ffffff;
      border: 4px solid #28a745;
      border-radius: 30px;
      text-align: center;
      padding: 20px 10px 15px 10px;
      display: none;
      z-index: 9999;
      box-shadow: 0 20px 30px black;
    }

    #popup .circle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #28a745;
      margin: 0 auto 12px auto;
      color: #fff;
      font-size: 40px;
      font-weight: bold;
      line-height: 64px;
    }

    #popup p {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #1e7e34;
    }

    #popup-time {
      font-size: 12px;
      margin-top: 8px;
      color: #666;
    }

    #statusBox {
      margin-top: 8px;
      font-size: 14px;
      text-align: center;
      min-height: 20px;
      font-weight: 500;
    }

    .error-detail {
      font-size: 11px;
      color: #b52e2e;
      margin-top: 2px;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <div class="device">

    <div class="header">
      <div class="header-title">Scan Barcode</div>
      <div class="header-time" id="deviceTime">--:--</div>
    </div>

    <div class="scan-row">
      <button class="submit-btn" id="submitBtn">SUBMIT</button>

      <div class="mini-grid">
        <input class="mini-cell" maxlength="1" id="cell1">
        <input class="mini-cell" maxlength="1" id="cell2">
        <input class="mini-cell" maxlength="1" id="cell3">
        <input class="mini-cell" maxlength="1" id="cell4">
        <input class="mini-cell" maxlength="1" id="cell5">
        <input class="mini-cell" maxlength="1" id="cell6">
      </div>
    </div>

    <div class="content">
      <video id="preview" autoplay muted playsinline></video>

      <!-- STATUS FIELDS -->
      <div class="status-fields">
        <div class="field-row">
          <label>Decoded Label ID</label>
          <input type="text" id="decoded" readonly>
        </div>
        
        <div class="field-row">
          <label>Entry Type</label>
          <input type="text" id="barcode_type" value="manual" readonly>
        </div>

        <div class="field-row">
          <label>Status</label>
          <select id="status">
            <option value="Data Received">üì• Data Received</option>
            <option value="Picked Up">üì¨ Picked Up</option>
            <option value="Depart Post Office">üöö Depart Post Office</option>
            <option value="Arrival Scan">üìç Arrival Scan</option>
            <option value="Local Scan">üèôÔ∏è Local Scan</option>
            <option value="Out For Delivery">üõµ Out For Delivery</option>
            <option value="Delivered">‚úÖ Delivered</option>
          </select>
        </div>

        <div class="field-row">
          <label>Location</label>
          <input type="text" id="location" placeholder="City, State">
        </div>

        <div class="field-row">
          <label>ETA</label>
          <input type="text" id="eta" placeholder="e.g., 2025-03-15">
        </div>
      </div>

      <!-- RESULT BOX -->
      <div class="result-box">
        <div class="result-header">
          <div class="result-cell">#</div>
          <div class="result-cell">LABEL ID</div>
        </div>

        <div id="emptyRow" class="result-row">
          <div class="result-cell"></div>
          <div class="result-cell"></div>
        </div>

        <div id="resultTable"></div>
      </div>

      <!-- STATUS MESSAGE -->
      <div id="statusBox"></div>
      <div id="errorDetail" class="error-detail"></div>
    </div>

    <!-- SUCCESS POPUP -->
    <div id="popup">
      <div class="circle">‚úì</div>
      <p>SAVED OK</p>
      <p id="popup-time"></p>
    </div>

  </div>

  <script src="https://unpkg.com/@zxing/library@0.18.6"></script>

  <script>
    /* ========== SIMPLE DEVICE TIME - NO BULLSHIT ========== */
    function updateDeviceTime() {
      var now = new Date();
      var hours = String(now.getHours()).padStart(2, '0');
      var minutes = String(now.getMinutes()).padStart(2, '0');
      var seconds = String(now.getSeconds()).padStart(2, '0');
      document.getElementById('deviceTime').textContent = hours + ':' + minutes + ':' + seconds;
    }
    
    updateDeviceTime();
    setInterval(updateDeviceTime, 1000);

    /* ========== CELLS ========== */
    var cells = [
      document.getElementById('cell1'),
      document.getElementById('cell2'),
      document.getElementById('cell3'),
      document.getElementById('cell4'),
      document.getElementById('cell5'),
      document.getElementById('cell6')
    ];

    for (let i = 0; i < cells.length; i++) {
      cells[i].oninput = function() {
        this.style.background = "#FB9809";
        if (this.value.length === 1 && i < cells.length - 1) {
          cells[i + 1].focus();
        }
        checkManualEntry();
      };

      cells[i].onkeydown = function(e) {
        if (e.keyCode === 8 && this.value === "" && i > 0) {
          cells[i - 1].focus();
        }
      };
    }

    function checkManualEntry() {
      let code = "";
      for (let i = 0; i < cells.length; i++) {
        code += cells[i].value;
      }
      if (code.length === 6) {
        var decoded = decodeLetters(code);
        if (decoded) {
          document.getElementById('decoded').value = decoded;
          addRow(code);
        } else {
          alert('Invalid letters. Use A-J only');
        }
      }
    }

    function decodeLetters(encoded) {
      var map = {
        'A': '1','B': '2','C': '3','D': '4','E': '5',
        'F': '6','G': '7','H': '8','I': '9','J': '0'
      };
      var result = '';
      var upper = encoded.toUpperCase();
      for (var i = 0; i < upper.length; i++) {
        var ch = upper.charAt(i);
        if (!map[ch]) return null;
        result += map[ch];
      }
      return result;
    }

    /* ========== RESULT TABLE ========== */
    let scanIndex = 0;

    function addRow(value) {
      scanIndex++;
      document.getElementById("emptyRow").style.display = "none";
      let row = `
        <div class="result-row">
          <div class="result-cell">${scanIndex}</div>
          <div class="result-cell result-cell-value">${value}</div>
        </div>
      `;
      document.getElementById("resultTable").insertAdjacentHTML("beforeend", row);
    }

    function showPopup() {
      var p = document.getElementById('popup');
      var now = new Date();
      var dateStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
      document.getElementById('popup-time').innerHTML = dateStr;
      p.style.display = 'block';
      setTimeout(function() {
        p.style.display = 'none';
      }, 2000);
    }

    function setStatus(msg, isError) {
      var box = document.getElementById('statusBox');
      box.style.color = isError ? '#b52e2e' : '#1e6f3f';
      box.innerHTML = msg || ' ';
    }

    function showErrorDetail(detail) {
      document.getElementById('errorDetail').innerHTML = detail;
    }

    /* ========== SEND TO XANO (DEVICE TIME) ========== */
    function sendToXano() {
      var labelId = document.getElementById('decoded').value;
      
      if (!labelId) {
        setStatus('‚ùó Enter a valid barcode first', true);
        return;
      }

      var now = new Date();
      
      // Payload with ALL required fields
      var payload = {
        label_id: labelId,
        barcode_type: "manual",
        status: document.getElementById('status').value,
        timestamp: Math.floor(now.getTime() / 1000),  // seconds
        time: now.getTime(),                           // milliseconds
        date: now.toISOString().split('T')[0],
        location: document.getElementById('location').value || '',
        eta: document.getElementById('eta').value || ''
      };

      console.log('üì§ SENDING:', JSON.stringify(payload, null, 2));
      
      showErrorDetail('');

      var xhr = new XMLHttpRequest();
      xhr.open('POST', 'https://x8ki-letl-twmt.n7.xano.io/api:WGx5FQAG/qr_scans', true);
      xhr.setRequestHeader('Content-Type', 'application/json');

      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
          console.log('üì• RESPONSE:', xhr.status, xhr.responseText);
          
          if (xhr.status >= 200 && xhr.status < 300) {
            showPopup();
            setStatus('‚úì Saved successfully', false);
            
            // Clear cells
            for (var i = 0; i < cells.length; i++) {
              cells[i].value = '';
              cells[i].style.background = '#E2E8D3';
            }
            document.getElementById('decoded').value = '';
            cells[0].focus();
          } else {
            setStatus('Error ' + xhr.status, true);
            try {
              var err = JSON.parse(xhr.responseText);
              showErrorDetail(JSON.stringify(err));
            } catch(e) {
              showErrorDetail(xhr.responseText);
            }
          }
        }
      };

      xhr.onerror = function() {
        setStatus('Network error', true);
        showErrorDetail('Check internet connection');
      };

      xhr.send(JSON.stringify(payload));
    }

    /* ========== EVENT LISTENERS ========== */
    document.getElementById('submitBtn').addEventListener('click', function(e) {
      e.preventDefault();
      sendToXano();
    });

    cells.forEach(cell => {
      cell.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendToXano();
        }
      });
    });

    window.addEventListener('load', function() {
      cells[0].focus();
      console.log('‚úÖ Using device time - no forced dates');
    });

  </script>
</body>
</html>
