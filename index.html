<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>QR Scanner · WinCE 2007</title>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body {
    background: #000000;
    font-family: 'Tahoma', 'Arial', sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}

#device {
    width: 320px;
    height: 480px;
    background: #c0c0c0;
    border: 3px solid #808080;
    border-radius: 8px;
    position: relative;
    overflow: hidden;
    box-shadow: 2px 2px 10px rgba(0,0,0,0.5);
}

/* WinCE Classic Silver Theme */
.wince-window {
    width: 100%;
    height: 100%;
    background: #d4d0c8;
    display: flex;
    flex-direction: column;
}

.wince-titlebar {
    height: 24px;
    background: #0a246a;
    color: white;
    font-size: 12px;
    font-weight: bold;
    padding: 4px 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid #808080;
}

.wince-titlebar span {
    text-shadow: none;
    letter-spacing: 0;
}

.wince-menu {
    height: 22px;
    background: #b0b0b0;
    border-bottom: 2px solid #808080;
    display: flex;
    padding: 2px 4px;
    gap: 8px;
}

.wince-menu-item {
    color: black;
    font-size: 11px;
    font-weight: bold;
    padding: 2px 6px;
    border: 1px solid #d4d0c8;
    background: #c0c0c0;
    cursor: pointer;
}

.wince-menu-item:active {
    border: 1px solid #808080;
    background: #a0a0a0;
}

.wince-content {
    flex: 1;
    padding: 8px;
    background: #d4d0c8;
    overflow-y: auto;
}

.wince-panel {
    border: 2px solid;
    border-color: #ffffff #808080 #808080 #ffffff;
    background: #c0c0c0;
    padding: 4px;
    margin-bottom: 8px;
}

.wince-panel-label {
    font-size: 11px;
    font-weight: bold;
    color: black;
    margin-bottom: 2px;
}

.wince-button {
    border: 2px solid;
    border-color: #ffffff #808080 #808080 #ffffff;
    background: #c0c0c0;
    color: black;
    font-size: 12px;
    font-weight: bold;
    padding: 6px 12px;
    text-align: center;
    cursor: pointer;
    display: inline-block;
    width: 100%;
    margin: 2px 0;
}

.wince-button:active {
    border-color: #808080 #ffffff #ffffff #808080;
    background: #a0a0a0;
}

.wince-button.primary {
    background: #0a246a;
    color: white;
}

.wince-button.primary:active {
    background: #1a3a8a;
}

.wince-textbox {
    border: 2px solid;
    border-color: #808080 #ffffff #ffffff #808080;
    background: white;
    padding: 4px;
    font-size: 12px;
    font-family: 'Courier New', monospace;
    min-height: 60px;
    max-height: 100px;
    overflow-y: auto;
    color: black;
}

.wince-textbox span.scan-entry {
    display: block;
    border-bottom: 1px solid #808080;
    padding: 2px 0;
    font-size: 11px;
}

.wince-statusbar {
    height: 22px;
    background: #b0b0b0;
    border-top: 2px solid #808080;
    display: flex;
    align-items: center;
    padding: 2px 6px;
    font-size: 11px;
    font-weight: bold;
    color: black;
    gap: 8px;
}

#scanFrame {
    width: 100%;
    height: 120px;
    border: 2px solid;
    border-color: #808080 #ffffff #ffffff #808080;
    margin: 8px 0;
    position: relative;
    display: none;
    background: black;
}

#preview {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

#laser {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: #ff0000;
    animation: laserMove 2s linear infinite;
    display: none;
}

@keyframes laserMove {
    0% { top: 0; }
    50% { top: 118px; }
    100% { top: 0; }
}

.corner {
    width: 12px;
    height: 12px;
    border: 2px solid #00ff00;
    position: absolute;
}

.tl { top: -2px; left: -2px; border-right: none; border-bottom: none; }
.tr { top: -2px; right: -2px; border-left: none; border-bottom: none; }
.bl { bottom: -2px; left: -2px; border-right: none; border-top: none; }
.br { bottom: -2px; right: -2px; border-left: none; border-top: none; }

.wince-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 4px;
    margin-top: 8px;
}

.wince-grid button {
    border: 2px solid;
    border-color: #ffffff #808080 #808080 #ffffff;
    background: #c0c0c0;
    color: black;
    font-size: 14px;
    font-weight: bold;
    padding: 8px;
    cursor: pointer;
}

.wince-grid button:active {
    border-color: #808080 #ffffff #ffffff #808080;
    background: #a0a0a0;
}

.wince-tabs {
    display: flex;
    gap: 2px;
    margin-bottom: 4px;
}

.wince-tab {
    flex: 1;
    border: 2px solid;
    border-color: #ffffff #808080 #808080 #ffffff;
    background: #c0c0c0;
    color: black;
    font-size: 11px;
    font-weight: bold;
    padding: 4px;
    text-align: center;
    cursor: pointer;
}

.wince-tab.active {
    border-color: #808080 #ffffff #ffffff #808080;
    background: #a0a0a0;
}

.wince-popup {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
}

.wince-popup-content {
    width: 200px;
    border: 3px solid;
    border-color: #ffffff #808080 #808080 #ffffff;
    background: #d4d0c8;
    padding: 16px;
    text-align: center;
}

.gps-on { color: #008000; }
.gps-off { color: #800000; }
</style>

<!-- jsQR library -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
// Global functions for onclick handlers
var stream = null;
var scanning = false;
var scanCount = 0;
var animationFrame = null;
var currentScans = [];
var currentLocation = null;
var gpsWatchId = null;
var XANO_URL = 'https://your-xano-endpoint.com';

// Initialize everything when page loads
function init() {
    console.log('Initializing...');
    initGPS();
    updateTime();
    setInterval(updateTime, 1000);
    
    // FIXED: Set button event listeners
    document.getElementById('scanButton').onclick = function() { startScan(); };
    document.getElementById('clearBtn').onclick = function() { clearScans(); };
    document.getElementById('statusBtn').onclick = function() { showStatus(); };
    
    // FIXED: Set menu item listeners
    var menuItems = document.getElementsByClassName('wince-menu-item');
    if (menuItems.length > 0) {
        menuItems[0].onclick = function() { clearScans(); };
        menuItems[1].onclick = function() { showStatus(); };
    }
    
    // Set tab listeners
    document.getElementById('tabNumeric').onclick = function() { showNumeric(); };
    document.getElementById('tabQwerty').onclick = function() { showQwerty(); };
    
    // FIXED: Set keypad button listeners
    setupKeypadListeners();
    
    // Initial time display
    updateTime();
    
    console.log('Initialization complete');
}

// FIXED: Set up all keypad button listeners
function setupKeypadListeners() {
    // Numeric keypad
    var numericButtons = document.querySelectorAll('#numericPad button');
    for (var i = 0; i < numericButtons.length; i++) {
        var btn = numericButtons[i];
        var text = btn.innerHTML;
        
        if (text === '⌫ BACKSPACE') {
            btn.onclick = function() { backspace(); };
        } else {
            btn.onclick = function() { 
                var val = this.innerHTML;
                typeChar(val); 
            };
        }
    }
    
    // QWERTY keypad buttons
    var qwertyButtons = document.querySelectorAll('#qwertyPad button');
    for (var i = 0; i < qwertyButtons.length; i++) {
        var btn = qwertyButtons[i];
        var text = btn.innerHTML;
        
        if (text === 'SPACE') {
            btn.onclick = function() { typeChar(' '); };
        } else if (text.length === 1) {
            btn.onclick = function() { 
                typeChar(this.innerHTML); 
            };
        }
    }
}

// GPS Functions
function initGPS() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(pos) {
                currentLocation = {
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude
                };
                updateGPSIndicator(true);
            },
            function(err) {
                updateGPSIndicator(false);
            },
            { timeout: 10000, enableHighAccuracy: true }
        );
        
        gpsWatchId = navigator.geolocation.watchPosition(
            function(pos) {
                currentLocation = {
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude
                };
                updateGPSIndicator(true);
            },
            function(err) {
                updateGPSIndicator(false);
            },
            { timeout: 10000, enableHighAccuracy: true }
        );
    } else {
        updateGPSIndicator(false);
    }
}

function updateGPSIndicator(hasGPS) {
    var gps = document.getElementById('gpsIndicator');
    if (gps) {
        gps.className = hasGPS ? 'gps-on' : 'gps-off';
        gps.innerHTML = hasGPS ? 'GPS: ON' : 'GPS: OFF';
    }
}

// FIXED: Time display function
function updateTime() {
    var d = new Date();
    var hours = d.getHours();
    var minutes = d.getMinutes();
    var seconds = d.getSeconds();
    
    // Format with leading zeros
    var timeStr = (hours < 10 ? '0' + hours : hours) + ':' + 
                  (minutes < 10 ? '0' + minutes : minutes) + ':' + 
                  (seconds < 10 ? '0' + seconds : seconds);
    
    var timeDisplay = document.getElementById('timeDisplay');
    if (timeDisplay) {
        timeDisplay.innerHTML = timeStr;
    }
}

// Camera Functions
function stopCamera() {
    if (animationFrame) {
        cancelAnimationFrame(animationFrame);
        animationFrame = null;
    }
    if (stream) {
        try {
            stream.getTracks().forEach(function(t) { t.stop(); });
        } catch (e) {}
        stream = null;
    }
    scanning = false;
}

function startScan() {
    if (scanning) {
        stopCamera();
        document.getElementById('scanFrame').style.display = 'none';
        document.getElementById('laser').style.display = 'none';
        return;
    }
    
    scanning = true;
    var frame = document.getElementById('scanFrame');
    var laser = document.getElementById('laser');
    frame.style.display = 'block';
    laser.style.display = 'block';
    
    try {
        // Try modern API first
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(s) {
                    stream = s;
                    var video = document.getElementById('preview');
                    video.srcObject = s;
                    video.play();
                    startScanning();
                })
                .catch(function(err) {
                    handleCameraError(err);
                });
        } 
        // Fallback for older Android
        else if (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia) {
            var getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
            
            getUserMedia.call(navigator, { video: true },
                function(s) {
                    stream = s;
                    var video = document.getElementById('preview');
                    
                    if (window.URL && window.URL.createObjectURL) {
                        video.src = window.URL.createObjectURL(s);
                    } else if (window.webkitURL && window.webkitURL.createObjectURL) {
                        video.src = window.webkitURL.createObjectURL(s);
                    } else {
                        video.src = s;
                    }
                    
                    video.play();
                    startScanning();
                },
                function(err) {
                    handleCameraError(err);
                }
            );
        } else {
            alert('Camera not supported on this device');
            scanning = false;
            frame.style.display = 'none';
            laser.style.display = 'none';
        }
    } catch (e) {
        handleCameraError(e);
    }
}

function handleCameraError(err) {
    alert('Camera error: ' + (err.message || 'Could not access camera'));
    scanning = false;
    document.getElementById('scanFrame').style.display = 'none';
    document.getElementById('laser').style.display = 'none';
}

function startScanning() {
    var video = document.getElementById('preview');
    var canvas = document.createElement('canvas');
    var ctx = canvas.getContext('2d');
    
    function scanFrame() {
        if (!scanning || !video.videoWidth) {
            if (scanning) animationFrame = requestAnimationFrame(scanFrame);
            return;
        }
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        try {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            var code = jsQR(imageData.data, canvas.width, canvas.height);
            
            if (code) {
                onBarcodeDecoded(code.data);
                return;
            }
        } catch (e) {
            // Ignore QR errors
        }
        
        animationFrame = requestAnimationFrame(scanFrame);
    }
    
    animationFrame = requestAnimationFrame(scanFrame);
}

function onBarcodeDecoded(code) {
    if (!scanning) return;
    
    scanning = false;
    stopCamera();
    document.getElementById('scanFrame').style.display = 'none';
    document.getElementById('laser').style.display = 'none';
    
    scanCount++;
    currentScans.push({
        number: scanCount,
        code: code,
        timestamp: new Date().toISOString(),
        location: currentLocation
    });
    
    var box = document.getElementById('labelBox');
    var span = document.createElement('span');
    span.className = 'scan-entry';
    span.innerHTML = scanCount + '. ' + code + (currentLocation ? ' [GPS]' : '');
    box.appendChild(span);
    box.scrollTop = box.scrollHeight;
    
    document.getElementById('scanCount').innerHTML = 'Scans: ' + scanCount;
}

function clearScans() {
    scanCount = 0;
    currentScans = [];
    document.getElementById('labelBox').innerHTML = '';
    document.getElementById('scanCount').innerHTML = 'Scans: 0';
}

function showStatus() {
    if (currentScans.length === 0) {
        alert('No scans to submit');
        return;
    }
    
    var statusMsg = 'Submit ' + scanCount + ' scan(s)?\n\n';
    for (var i = 0; i < currentScans.length; i++) {
        var code = currentScans[i].code;
        statusMsg += (i+1) + ': ' + (code.length > 15 ? code.substr(0, 15) + '...' : code) + '\n';
    }
    
    if (confirm(statusMsg + '\nPress OK to submit')) {
        submitToXano();
    }
}

function submitToXano() {
    if (currentScans.length === 0) return;
    
    document.getElementById('successPopup').style.display = 'flex';
    setTimeout(function() {
        document.getElementById('successPopup').style.display = 'none';
        clearScans();
    }, 2000);
}

// Keypad Functions
function typeChar(c) {
    var box = document.getElementById('labelBox');
    var span = document.createElement('span');
    span.className = 'scan-entry';
    span.innerHTML = 'MANUAL: ' + c;
    box.appendChild(span);
    box.scrollTop = box.scrollHeight;
}

function backspace() {
    var box = document.getElementById('labelBox');
    if (box.lastChild) {
        box.removeChild(box.lastChild);
    }
}

function showNumeric() {
    document.getElementById('numericPad').style.display = 'grid';
    document.getElementById('qwertyPad').style.display = 'none';
    document.getElementById('tabNumeric').className = 'wince-tab active';
    document.getElementById('tabQwerty').className = 'wince-tab';
}

function showQwerty() {
    document.getElementById('numericPad').style.display = 'none';
    document.getElementById('qwertyPad').style.display = 'grid';
    document.getElementById('tabNumeric').className = 'wince-tab';
    document.getElementById('tabQwerty').className = 'wince-tab active';
}

// Set onload handler
window.onload = function() {
    init();
};

// Cleanup
window.onbeforeunload = function() {
    if (gpsWatchId) navigator.geolocation.clearWatch(gpsWatchId);
    stopCamera();
};
</script>
</head>
<body>
<div id="device">
    <div class="wince-window">
        <!-- WinCE Title Bar -->
        <div class="wince-titlebar">
            <span>QR Scanner v1.0</span>
            <span id="timeDisplay">00:00:00</span>
        </div>
        
        <!-- WinCE Menu Bar -->
        <div class="wince-menu">
            <div class="wince-menu-item">File</div>
            <div class="wince-menu-item">Edit</div>
            <div class="wince-menu-item">View</div>
            <div class="wince-menu-item">Tools</div>
        </div>
        
        <!-- Main Content -->
        <div class="wince-content">
            <!-- Scan Button -->
            <div id="scanButton" class="wince-button primary">
                ▶ SCAN QR CODE
            </div>
            
            <!-- Camera Preview -->
            <div id="scanFrame">
                <video id="preview" autoplay playsinline></video>
                <div id="laser"></div>
                <div class="corner tl"></div>
                <div class="corner tr"></div>
                <div class="corner bl"></div>
                <div class="corner br"></div>
            </div>
            
            <!-- Scan Results Panel -->
            <div class="wince-panel-label">Scan Results:</div>
            <div class="wince-panel">
                <div id="labelBox" class="wince-textbox"></div>
            </div>
            
            <!-- GPS Status -->
            <div class="wince-panel-label">Status:</div>
            <div class="wince-panel" style="padding: 4px;">
                <span id="gpsIndicator">GPS: OFF</span>
                <span style="float: right;" id="scanCount">Scans: 0</span>
            </div>
            
            <!-- Control Buttons -->
            <div style="display: flex; gap: 4px; margin: 8px 0;">
                <div id="clearBtn" class="wince-button" style="flex: 1;">CLEAR</div>
                <div id="statusBtn" class="wince-button primary" style="flex: 1;">SUBMIT</div>
            </div>
            
            <!-- Keypad Tabs -->
            <div class="wince-tabs">
                <div id="tabNumeric" class="wince-tab active">123</div>
                <div id="tabQwerty" class="wince-tab">ABC</div>
            </div>
            
            <!-- Numeric Keypad -->
            <div id="numericPad" class="wince-grid">
                <button>1</button>
                <button>2</button>
                <button>3</button>
                <button>4</button>
                <button>5</button>
                <button>6</button>
                <button>7</button>
                <button>8</button>
                <button>9</button>
                <button>*</button>
                <button>0</button>
                <button>#</button>
                <button style="grid-column: span 3;">⌫ BACKSPACE</button>
            </div>
            
            <!-- QWERTY Keypad -->
            <div id="qwertyPad" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; margin-bottom: 2px;">
                    <button>q</button><button>w</button><button>e</button><button>r</button>
                    <button>t</button><button>y</button><button>u</button><button>i</button>
                    <button>o</button><button>p</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(9, 1fr); gap: 2px; margin-bottom: 2px;">
                    <button>a</button><button>s</button><button>d</button><button>f</button>
                    <button>g</button><button>h</button><button>j</button><button>k</button>
                    <button>l</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;">
                    <button>z</button><button>x</button><button>c</button><button>v</button>
                    <button>b</button><button>n</button><button>m</button>
                </div>
                <div style="margin-top: 4px;">
                    <button style="width: 100%;">SPACE</button>
                </div>
            </div>
        </div>
        
        <!-- WinCE Status Bar -->
        <div class="wince-statusbar">
            <span>QR Scanner</span>
            <span style="flex: 1;"></span>
            <span>COM1</span>
            <span>|</span>
            <span>BAT: 100%</span>
        </div>
    </div>
    
    <!-- Success Popup -->
    <div id="successPopup" class="wince-popup">
        <div class="wince-popup-content">
            <div style="font-size: 24px; margin-bottom: 8px;">✓</div>
            <div style="font-weight: bold;">SCANS SENT</div>
            <div style="font-size: 11px; margin-top: 4px;">to server</div>
        </div>
    </div>
</div>
</body>
</html>
