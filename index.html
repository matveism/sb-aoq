<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Scanner ¬∑ Xano PRO</title>

<style>
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
body { margin:0; padding:0; background:#000; display:flex; justify-content:center; align-items:center; min-height:100vh; font-family:'Roboto','Segoe UI',Arial,sans-serif; font-weight:700; }
#phone { width:360px; height:640px; background:linear-gradient(180deg,#3f6b9c 0%,#2b4b70 100%); color:#fff; position:relative; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 10px 25px rgba(0,0,0,0.5); }
#header { width:100%; height:38px; background:linear-gradient(180deg,#5180b0 0%,#2e5a88 100%); border-bottom:2px solid #1f3f5c; display:flex; justify-content:space-between; align-items:center; padding:0 12px; font-weight:700; font-size:16px; z-index:2; flex-shrink:0; letter-spacing:0.3px; }
#leftText{color:#fff;} #rightArea{color:#fff;font-size:14px;display:flex;align-items:center;gap:8px;}
#gpsIndicator{color:#4CAF50;font-size:16px;}
#scanButton { width:calc(100% - 24px); height:50px; background:linear-gradient(180deg,#4CAF50 0%,#2b6e2f 100%); border:2px solid #1e5a22; color:#fff; font-size:22px; font-weight:700; text-align:center; line-height:48px; margin:12px auto 8px auto; border-radius:6px; z-index:2; box-shadow:0 4px 0 #145018; cursor:pointer; flex-shrink:0; display:flex; align-items:center; justify-content:center; gap:8px; letter-spacing:0.5px;}
#scanButton:active { transform:translateY(2px); box-shadow:0 2px 0 #145018; }
#scanFrame { width:280px; height:160px; border:2px solid rgba(255,255,255,0.6); margin:4px auto 0 auto; position:relative; display:none; z-index:3; overflow:hidden; flex-shrink:0; background:rgba(0,0,0,0.4); }
#preview { width:100%; height:100%; object-fit:cover; display:block; }
#laser { position:absolute; top:0; left:0; width:100%; height:2px; background:#ff3333; box-shadow:0 0 10px #ff0000; animation:laserMove 1.8s linear infinite; display:none; z-index:5; }
@keyframes laserMove { 0%{top:0;} 50%{top:158px;} 100%{top:0;} }
.corner { width:22px; height:22px; border:3px solid #ffcc00; position:absolute; pointer-events:none; }
.tl{top:-3px; left:-3px; border-right:none; border-bottom:none;}
.tr{top:-3px; right:-3px; border-left:none; border-bottom:none;}
.bl{bottom:-3px; left:-3px; border-right:none; border-top:none;}
.br{bottom:-3px; right:-3px; border-left:none; border-top:none;}
#labelBlock { display:flex; flex-direction:column; flex:1; min-height:0; width:100%; z-index:2; margin-top:4px; }
#labelTitle { height:32px; background:linear-gradient(180deg,#3f6b9c 0%,#2b4b70 100%); border:1px solid #1f3f5c; display:flex; align-items:center; padding-left:12px; margin:0 12px; font-weight:700; font-size:14px; color:#fff; flex-shrink:0; letter-spacing:0.5px; }
#labelBox { width:calc(100% - 24px); min-height:80px; max-height:120px; margin:0 auto; border:3px solid #1f3f5c; background:#A6BEEF; padding:8px 10px; font-size:16px; font-weight:700; color:#000; white-space:pre-line; overflow-y:auto; word-break:break-all; flex-shrink:0; line-height:1.5; font-family:'Roboto','Segoe UI',monospace; box-shadow:inset 0 0 0 2px #fff; }
#labelBox span.scan-entry { display:block; border-bottom:2px solid #2b4b70; background:#c0d4f5; padding:4px 6px; margin:4px 0; border-radius:4px; font-weight:700; color:#000; }
#labelBox span.scan-entry:last-child{border-bottom:none;}
#labelButtons { height:42px; background:#7496C4; display:flex; align-items:center; justify-content:space-between; border-radius:4px; border:2px solid #3a5f8a; margin:8px 12px 0 12px; padding:0 20px; font-weight:700; font-size:18px; color:#fff; flex-shrink:0; box-shadow:inset 0 -2px 0 #3a5f8a; }
#labelButtons span { cursor:pointer; padding:4px 12px; background:transparent; text-shadow:1px 1px 0 #1f3f5c; }
#labelButtons span:active { background:#27ae60; border-radius:4px; }
#divider { color: rgba(255,255,255,0.7); padding:0 !important; }
#navBar { height:36px; background:linear-gradient(180deg,#4a7aa8 0%,#2b4b70 100%); display:flex; align-items:center; justify-content:space-between; border-radius:4px; border:1px solid #1f3f5c; margin:8px 12px 0 12px; padding:0 16px; font-weight:700; font-size:14px; color:#fff; flex-shrink:0; }
#navBar button { background:transparent; border:none; color:white; font-size:20px; font-weight:700; cursor:pointer; padding:4px 8px; }
#navBar button:active { color:#4CAF50; }
#keypadWrapper { width:100%; background:linear-gradient(180deg,#2b4b70 0%,#1f3f5c 100%); border-top:3px solid #ffcc00; margin-top:auto; flex-shrink:0; z-index:2; padding-bottom:4px; }
#keyTabs{display:flex; gap:8px; padding:8px 12px 4px 12px;} 
#keyTabs button{flex:1; background:#3a5f8a; border:2px solid #1f3f5c; border-radius:30px; color:#fff; font-size:14px; font-weight:700; padding:8px 0; cursor:pointer;}
#keyTabs button.active{background:#4CAF50; border-color:#145018;}
#keyTabs button:active{background:#66BB6A;}
#numericPad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:6px 15px 10px 15px;}
#numericPad button{background:linear-gradient(180deg,#5a7a9a 0%,#3a5f8a 100%); border:1px solid #1f3f5c; border-radius:6px;color:#fff; font-size:22px; font-weight:700; height:48px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 3px 0 #1f3f5c;}
#numericPad button:active{transform:translateY(2px); background:#4CAF50;}
#numericPad button.backspace{background:linear-gradient(180deg,#3a5f8a 0%,#2b4b70 100%);}
#qwertyPad, #symbolPad{display:none; padding:0 8px 12px 8px;}
.row{display:flex; gap:4px; margin-bottom:4px; justify-content:center;}
.row button{flex:1; max-width:32px; background:linear-gradient(180deg,#5a7a9a 0%,#3a5f8a 100%); border:1px solid #1f3f5c; border-radius:6px; color:#fff; font-size:16px; font-weight:700; height:40px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 0 #1f3f5c;}
.row button:active{transform:translateY(2px); background:#4CAF50;}
.row button.special{background:linear-gradient(180deg,#3a5f8a 0%,#2b4b70 100%); max-width:50px;}
.row button.space{flex:3; max-width:200px;}
#statusScreen{display:none; flex-direction:column; position:absolute; top:38px; left:0; right:0; bottom:0; background:rgba(28,48,70,0.98); z-index:100; padding:20px 16px; overflow-y:auto; gap:10px;}
.statusBtn{background:linear-gradient(180deg,#3f6b9c 0%,#2b4b70 100%); border:2px solid #ffcc00; color:white; font-size:18px; font-weight:700; padding:16px 8px; text-align:center; border-radius:8px; cursor:pointer;}
.statusBtn:active{background:#4CAF50;}
.statusBtn.back{background:linear-gradient(180deg,#3a5f8a 0%,#1f3f5c 100%); border-color:#f1c40f; margin-top:25px;}
#successPopup{display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center;}
.popup-content{background:linear-gradient(180deg,#3f6b9c 0%,#2b4b70 100%); border:3px solid #27ae60; border-radius:20px; padding:30px 20px; text-align:center; width:280px; animation:fadePop 0.2s;}
.checkmark{width:70px;height:70px;background:#27ae60;border-radius:50%; font-size:48px; display:flex; align-items:center; justify-content:center; margin:0 auto 15px auto; color:white;}
.popup-message{font-size:20px; font-weight:700;}
.popup-submessage{color:#ffcc00;font-size:15px;margin-top:5px;}
.eta-info{color:#4CAF50;font-size:14px;margin-top:10px;border-top:1px solid #fff;padding-top:10px;}
@keyframes fadePop{0%{opacity:0;transform:scale(0.7);}100%{opacity:1;transform:scale(1);}}
#labelBox::-webkit-scrollbar{width:4px;} 
#labelBox::-webkit-scrollbar-thumb{background:#1f3f5c;}
#barcodeType{font-size:10px;color:#ffcc00;margin-left:5px;font-weight:normal;}
#errorMessage{color:#ff4444;text-align:center;padding:10px;font-size:14px;display:none;}
</style>

<!-- jsQR library -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
(function(){
let stream=null, scanning=false, scanCount=0, animationFrame=null, currentScans=[], currentLocation=null, gpsWatchId=null;
// --------- REPLACE WITH YOUR XANO ENDPOINT URL ---------
const XANO_URL = 'https://YOUR_XANO_ENDPOINT_HERE'; 
//------------------------------------------------------
let audioCtx=null;
function playBeep(){try{if(!audioCtx){audioCtx=new (window.AudioContext||window.webkitAudioContext)();}
if(audioCtx.state==='suspended'){audioCtx.resume().then(()=>{createAndPlayBeep(audioCtx);}).catch(e=>console.warn(e));}else{createAndPlayBeep(audioCtx);}}catch(e){console.warn(e);}}
function createAndPlayBeep(ctx){const now=ctx.currentTime;const osc=ctx.createOscillator();const gain=ctx.createGain();osc.type='sine';osc.frequency.value=880;gain.gain.setValueAtTime(0.3,now);gain.gain.exponentialRampToValueAtTime(0.01,now+0.15);osc.connect(gain).connect(ctx.destination);osc.start(now);osc.stop(now+0.15);}

// GPS
function initGPS(){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(pos=>{currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude,accuracy:pos.coords.accuracy};updateGPSIndicator(true);},err=>{updateGPSIndicator(false);},{enableHighAccuracy:true,timeout:10000});
gpsWatchId=navigator.geolocation.watchPosition(pos=>{currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude,accuracy:pos.coords.accuracy};updateGPSIndicator(true);},err=>{updateGPSIndicator(false);},{enableHighAccuracy:true,timeout:10000,maximumAge:0});}else{updateGPSIndicator(false);}}
function updateGPSIndicator(hasGPS){const gps=document.getElementById('gpsIndicator');gps.innerHTML=hasGPS?'üõ∞Ô∏è':'üåê';gps.style.color=hasGPS?'#4CAF50':'#ff4444';}

function stopCamera(){if(animationFrame){cancelAnimationFrame(animationFrame);animationFrame=null;}
if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;} scanning=false;}

async function startScan(){if(scanning){stopCamera();return;} scanning=true;
const frame=document.getElementById('scanFrame');const laser=document.getElementById('laser');frame.style.display='block';laser.style.display='block';
try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){throw new Error('Browser does not support camera');}
stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{min:360,ideal:640,max:1280},height:{min:240,ideal:480,max:720}}});
const video=document.getElementById('preview');video.srcObject=stream;
await new Promise(resolve=>{video.onloadedmetadata=()=>{video.play().then(resolve);};});
const canvas=document.createElement('canvas');const ctx=canvas.getContext('2d');
function scanFrame(){if(!scanning||!video.videoWidth){animationFrame=requestAnimationFrame(scanFrame);return;}
canvas.width=video.videoWidth;canvas.height=video.videoHeight;ctx.drawImage(video,0,0,canvas.width,canvas.height);
const code=jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data,canvas.width,canvas.height,{inversionAttempts:"dontInvert"});
if(code){onBarcodeDecoded(code.data,'QR Code');return;} animationFrame=requestAnimationFrame(scanFrame);}
animationFrame=requestAnimationFrame(scanFrame);}catch(err){console.error(err);scanning=false;frame.style.display='none';laser.style.display='none';alert(err.message||'Camera error');}}

function onBarcodeDecoded(code,type){scanning=false;stopCamera();document.getElementById('scanFrame').style.display='none';document.getElementById('laser').style.display='none';playBeep();
scanCount++;currentScans.push({number:scanCount,code,type,timestamp:new Date().toISOString(),location:currentLocation});
const box=document.getElementById('labelBox');const span=document.createElement('span');span.className='scan-entry';
span.innerHTML=scanCount+'  '+code+(currentLocation?' üìç':'')+'<span id="barcodeType"> ['+type+']</span>';box.appendChild(span);box.scrollTop=box.scrollHeight;}

function clearScans(){scanCount=0;currentScans=[];document.getElementById('labelBox').innerHTML='';}

function goToStatus(){if(currentScans.length===0){alert('Please scan a QR code first');return;}
document.getElementById('labelBlock').style.display='none';document.getElementById('scanButton').style.display='none';
document.getElementById('leftText').innerText='SELECT STATUS';document.getElementById('statusScreen').style.display='flex';}

function goBackToScan(){document.getElementById('statusScreen').style.display='none';document.getElementById('labelBlock').style.display='flex';document.getElementById('scanButton').style.display='flex';document.getElementById('leftText').innerText='SCAN QR CODE';}

function calculateETA(status){const now=new Date();let eta=new Date(now);
switch(status){case'Data Received':eta.setDate(now.getDate()+7);break;case'Picked Up':eta.setDate(now.getDate()-1);break;case'Depart Post Office':eta.setDate(now.getDate()-2);break;case'Arrival Scan':eta.setHours(now.getHours()-12);break;case'Local Scan':eta.setHours(now.getHours()-36);break;case'Out For Delivery':eta.setHours(now.getHours()+3);break;case'Delivered':eta.setHours(now.getHours()+1);break;default:eta.setDate(now.getDate()+1);}
return eta.toLocaleString();}

async function submitToXano(status){if(currentScans.length===0){alert('No scans to submit');return;}
const payload=currentScans.map(s=>({barcode:s.code,type:s.type,timestamp:s.timestamp,location:s.location,status:status}));
try{const resp=await fetch(XANO_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:payload})});
if(resp.ok){showSuccess(status);}else{alert('Xano submission failed');}}catch(e){console.error(e);alert('Network error');}}

function showSuccess(status){const popup=document.getElementById('successPopup');popup.style.display='flex';popup.querySelector('.popup-message').innerText='Status: '+status;popup.querySelector('.eta-info').innerText='ETA: '+calculateETA(status);setTimeout(()=>{popup.style.display='none';clearScans();goBackToScan();},2500);}

window.addEventListener('load',()=>{initGPS();document.getElementById('scanButton').addEventListener('click',startScan);
document.getElementById('clearBtn').addEventListener('click',clearScans);document.getElementById('statusBtn').addEventListener('click',goToStatus);
document.querySelectorAll('.statusBtn').forEach(btn=>{if(btn.dataset.status){btn.addEventListener('click',()=>submitToXano(btn.dataset.status));}else{btn.addEventListener('click',goBackToScan);}});});

// ----------------- Keypad logic -----------------
function insertChar(c){const box=document.getElementById('labelBox');const span=document.createElement('span');span.className='scan-entry';span.innerText=c;box.appendChild(span);box.scrollTop=box.scrollHeight;}
function deleteChar(){const box=document.getElementById('labelBox');if(box.lastChild)box.removeChild(box.lastChild);}
function switchPad(pad){document.getElementById('numericPad').style.display='none';document.getElementById('qwertyPad').style.display='none';document.getElementById('symbolPad').style.display='none';document.getElementById(pad).style.display='grid';
document.querySelectorAll('#keyTabs button').forEach(b=>b.classList.remove('active'));document.querySelector('#keyTabs button[data-target="'+pad+'"]').classList.add('active');}
</script>
</head>
<body>
<div id="phone">
  <div id="header"><span id="leftText">SCAN QR CODE</span><span id="rightArea">GPS: <span id="gpsIndicator">üõ∞Ô∏è</span></span></div>
  <div id="scanButton">SCAN QR</div>
  <div id="scanFrame"><video id="preview" autoplay playsinline></video><div id="laser"></div>
    <div class="corner tl"></div><div class="corner tr"></div><div class="corner bl"></div><div class="corner br"></div>
  </div>
  <div id="labelBlock">
    <div id="labelTitle">Scanned Barcodes</div>
    <div id="labelBox"></div>
    <div id="labelButtons"><span id="clearBtn">CLEAR</span><span id="statusBtn">STATUS</span></div>
  </div>

  <div id="statusScreen">
    <div class="statusBtn" data-status="Data Received">Data Received</div>
    <div class="statusBtn" data-status="Picked Up">Picked Up</div>
    <div class="statusBtn" data-status="Depart Post Office">Depart Post Office</div>
    <div class="statusBtn" data-status="Arrival Scan">Arrival Scan</div>
    <div class="statusBtn" data-status="Local Scan">Local Scan</div>
    <div class="statusBtn" data-status="Out For Delivery">Out For Delivery</div>
    <div class="statusBtn" data-status="Delivered">Delivered</div>
    <div class="statusBtn back">Back</div>
  </div>

  <div id="successPopup">
    <div class="popup-content">
      <div class="checkmark">‚úî</div>
      <div class="popup-message"></div>
      <div class="popup-submessage">Submission Success</div>
      <div class="eta-info"></div>
    </div>
  </div>
</div>
</body>
</html>
