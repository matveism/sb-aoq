<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Scanner Xano</title>
<style>
  body { font-family: Arial; background: #111; color: #fff; margin:0; padding:0; }
  #scanFrame { display:none; position:relative; width:100%; max-width:400px; margin:auto; }
  #preview { width:100%; border:2px solid #4CAF50; }
  #laser { display:none; position:absolute; top:50%; left:0; width:100%; height:2px; background:red; animation: laserMove 1s infinite alternate; }
  @keyframes laserMove { from {top:20%;} to {top:80%;} }
  #labelBox { max-height:200px; overflow:auto; margin:10px; border:1px solid #444; padding:5px; }
  .scan-entry { display:block; margin-bottom:2px; }
  button { margin:5px; padding:10px 15px; background:#4CAF50; color:#fff; border:none; border-radius:5px; }
  #statusScreen { display:none; flex-direction:column; align-items:center; justify-content:center; }
  #successPopup { display:none; position:fixed; top:40%; left:50%; transform:translate(-50%,-50%); background:#333; padding:20px; border-radius:10px; text-align:center; }
</style>
</head>
<body>

<div style="text-align:center; margin:10px;">
  <span id="gpsIndicator">üåê</span>
  <span id="timeDisplay"></span>
</div>

<div id="scanFrame">
  <video id="preview" autoplay playsinline></video>
  <div id="laser"></div>
</div>

<div id="labelBlock">
  <div id="labelBox"></div>
  <button id="scanButton" onclick="startScan()">Start Scan</button>
  <button onclick="goToStatus()">Select Status</button>
</div>

<div id="statusScreen">
  <button onclick="chooseStatus('Picked Up')">Picked Up</button>
  <button onclick="chooseStatus('Out For Delivery')">Out For Delivery</button>
  <button onclick="chooseStatus('Delivered')">Delivered</button>
  <button onclick="goBackToScan()">Back</button>
</div>

<div id="successPopup">
  <h3>Status: <span id="popupStatus"></span></h3>
  <div id="popupScanCount"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>
(function() {
  let stream = null, scanning = false, scanCount = 0, animationFrame = null;
  let currentScans = [], currentLocation = null, gpsWatchId = null;
  const XANO_API_URL = 'https://x8ki-letl-twmt.n7.xano.io/api:WGx5FQAG/qr_scans';

  // ---- Beep ----
  let audioCtx = null;
  function playBeep() {
    if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    if (audioCtx.state==='suspended') audioCtx.resume().then(()=>createBeep());
    else createBeep();
  }
  function createBeep() {
    const now=audioCtx.currentTime, osc=audioCtx.createOscillator(), gain=audioCtx.createGain();
    osc.type='sine'; osc.frequency.value=880;
    gain.gain.setValueAtTime(0.3, now);
    gain.gain.exponentialRampToValueAtTime(0.01, now+0.15);
    osc.connect(gain).connect(audioCtx.destination); osc.start(now); osc.stop(now+0.15);
  }

  // ---- GPS ----
  function initGPS() {
    if(!navigator.geolocation) return updateGPS(false);
    navigator.geolocation.getCurrentPosition(pos=>{ currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude}; updateGPS(true); },()=>updateGPS(false),{enableHighAccuracy:true,timeout:10000});
    gpsWatchId = navigator.geolocation.watchPosition(pos=>{currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude}; updateGPS(true);},()=>updateGPS(false),{enableHighAccuracy:true,timeout:10000,maximumAge:0});
  }
  function updateGPS(hasGPS){ const el=document.getElementById('gpsIndicator'); if(!el) return; el.innerHTML=hasGPS?'üõ∞Ô∏è':'üåê'; el.style.color=hasGPS?'#4CAF50':'#ff4444'; }

  // ---- Time ----
  function updateTime() {
    const d=new Date(),month=(d.getMonth()+1).toString().padStart(2,'0'),day=d.getDate().toString().padStart(2,'0'),hours=d.getHours(),minutes=d.getMinutes().toString().padStart(2,'0'),ampm=hours>=12?'PM':'AM',hour12=hours%12||12,str=`${month}/${day} ${hour12}:${minutes} ${ampm}`;
    const el1=document.getElementById('timeDisplay'); if(el1) el1.innerText=str;
  }
  setInterval(updateTime,1000); window.addEventListener('load',updateTime);

  // ---- Camera ----
  function stopCamera() { if(animationFrame) cancelAnimationFrame(animationFrame); animationFrame=null; if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;} scanning=false; }

  async function startScan() {
    if(scanning){ stopCamera(); return; }
    scanning=true; document.getElementById('scanFrame').style.display='block'; document.getElementById('laser').style.display='block';
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:'environment',width:640,height:480} });
      const video=document.getElementById('preview'); video.srcObject=stream; await new Promise(r=>{video.onloadedmetadata=()=>video.play().then(r);});
      const canvas=document.createElement('canvas'),ctx=canvas.getContext('2d');
      function scanFrame(){
        if(!scanning||!video.videoWidth){ animationFrame=requestAnimationFrame(scanFrame); return; }
        canvas.width=video.videoWidth; canvas.height=video.videoHeight;
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
        const code=jsQR(imageData.data,canvas.width,canvas.height,{inversionAttempts:"dontInvert"});
        if(code){ onBarcodeDecoded(code.data,'QR Code'); return; }
        animationFrame=requestAnimationFrame(scanFrame);
      }
      animationFrame=requestAnimationFrame(scanFrame);
    }catch(err){ console.error(err); scanning=false; document.getElementById('scanFrame').style.display='none'; document.getElementById('laser').style.display='none'; alert(err.message||'Camera not supported'); }
  }

  function onBarcodeDecoded(code,barcodeType){
    scanning=false; stopCamera(); playBeep(); scanCount++; currentScans.push({number:scanCount,code,barcodeType,timestamp:new Date().toISOString(),location:currentLocation});
    const box=document.getElementById('labelBox'); const span=document.createElement('span'); span.className='scan-entry'; span.innerHTML=`${scanCount} ${code} ${currentLocation?'üìç':''} [QR Code]`; box.appendChild(span); box.scrollTop=box.scrollHeight;
  }

  function clearScans(){ scanCount=0; currentScans=[]; document.getElementById('labelBox').innerHTML=''; }

  function goToStatus(){ if(currentScans.length===0){ alert('Scan first'); return; } document.getElementById('labelBlock').style.display='none'; document.getElementById('scanButton').style.display='none'; document.getElementById('leftText')?.innerText='SELECT STATUS'; document.getElementById('statusScreen').style.display='flex'; }

  function goBackToScan(){ document.getElementById('statusScreen').style.display='none'; document.getElementById('labelBlock').style.display='flex'; document.getElementById('scanButton').style.display='flex'; document.getElementById('leftText')?.innerText='SCAN QR CODE'; }

  async function sendToXano(status){
    const now=new Date();
    const payload=currentScans.map(scan=>({ label_id:scan.code, barcode_type:scan.barcodeType, status, timestamp:now.toISOString(), location:currentLocation?`${currentLocation.lat},${currentLocation.lng}`:'GPS Unavailable'}));
    try{ await Promise.all(payload.map(scan=>fetch(XANO_API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(scan)}))); console.log('‚úÖ Sent to Xano',payload); } catch(err){console.error(err);}
    return payload;
  }

  async function chooseStatus(status){
    const scannedPackages = await sendToXano(status);
    const etaInfo = scannedPackages.map(pkg=>`Package: ${pkg.label_id.substring(0,8)}... ETA: -`).join('<br>');
    document.getElementById('popupStatus').innerText=status;
    document.getElementById('popupScanCount').innerHTML=`${scanCount} QR code(s) recorded<br><div class="eta-info">${etaInfo}</div>`;
    document.getElementById('successPopup').style.display='flex';
    setTimeout(()=>{ document.getElementById('successPopup').style.display='none'; clearScans(); goBackToScan(); },4000);
  }

  // ---- Init ----
  window.addEventListener('load',()=>{ initGPS(); updateTime(); });
  window.startScan=startScan; window.clearScans=clearScans; window.goToStatus=goToStatus; window.chooseStatus=chooseStatus; window.goBackToScan=goBackToScan;
})();
</script>
